import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import axios from 'axios';
import { toast } from 'react-hot-toast';
import Layout from '@/components/Layout';
import { Zap, TrendingUp, Loader, AlertCircle } from 'lucide-react';

const API = process.env.REACT_APP_BACKEND_URL || 'https://trading-rebuild.preview.emergentagent.com';

function InstantBuy() {
  const navigate = useNavigate();
  const [selectedCoin, setSelectedCoin] = useState('');
  const [processing, setProcessing] = useState(false);
  const [loading, setLoading] = useState(true);
  const [availableCoins, setAvailableCoins] = useState([]);
  const [prices, setPrices] = useState({});
  const [processingAmount, setProcessingAmount] = useState(null);

  const presetAmounts = [50, 100, 250, 500];

  // Fetch available coins with liquidity
  useEffect(() => {
    fetchAvailableCoins();
  }, []);

  const fetchAvailableCoins = async () => {
    try {
      const response = await axios.get(`${API}/api/instant-buy/available-coins`);
      if (response.data.success) {
        const coins = response.data.coins;
        setAvailableCoins(coins);
        
        // Build prices object from coins
        const priceMap = {};
        coins.forEach(coin => {
          priceMap[coin.symbol] = coin.price_gbp || 0;
        });
        setPrices(priceMap);
        
        // Set first available coin as selected
        if (coins.length > 0 && !selectedCoin) {
          setSelectedCoin(coins[0].symbol);
        }
      }
    } catch (error) {
      console.error('Error fetching available coins:', error);
      toast.error('Failed to load available coins');
    } finally {
      setLoading(false);
    }
  };

  const handleFastBuy = async (amountGBP) => {
    if (!selectedCoin) {
      toast.error('Please select a cryptocurrency');
      return;
    }

    setProcessing(true);
    setProcessingAmount(amountGBP);

    try {
      const userData = localStorage.getItem('cryptobank_user');
      const user = userData ? JSON.parse(userData) : null;
      
      if (!user || !user.user_id) {
        toast.error('Please log in to make a purchase');
        navigate('/login');
        return;
      }

      const user_id = user.user_id;

      // Calculate crypto amount
      const price = prices[selectedCoin];
      if (!price || price === 0) {
        toast.error('Unable to fetch price for ' + selectedCoin);
        return;
      }

      const cryptoAmount = amountGBP / price;

      console.log('Executing Express Buy:', {
        user_id,
        crypto_currency: selectedCoin,
        fiat_amount: amountGBP,
        crypto_amount: cryptoAmount,
        ad_id: 'ADMIN_LIQUIDITY',
        buyer_wallet_address: 'internal_wallet'
      });

      // Execute instant buy via Express Buy endpoint
      const response = await axios.post(`${API}/api/express-buy/execute`, {
        user_id: user_id,
        crypto_currency: selectedCoin,
        fiat_amount: amountGBP,
        crypto_amount: cryptoAmount,
        ad_id: 'ADMIN_LIQUIDITY',
        buyer_wallet_address: 'internal_wallet',
        buyer_wallet_network: 'mainnet'
      });

      if (response.data.success) {
        toast.success(`‚úÖ Successfully bought ${cryptoAmount.toFixed(8)} ${selectedCoin} for ¬£${amountGBP}!`);
        setTimeout(() => {
          toast('Check your wallet for the new balance', { icon: 'üíº' });
          navigate('/wallet');
        }, 2000);
      } else {
        toast.error(response.data.message || 'Purchase failed');
      }
    } catch (error) {
      console.error('Fast buy error:', error);
      const errorMsg = error.response?.data?.detail || error.message;
      
      // Handle specific error cases
      if (errorMsg.includes('Insufficient admin liquidity')) {
        toast.error('‚ùå No liquidity available for this amount right now. Please try a smaller amount or different coin.', {
          duration: 5000
        });
      } else if (errorMsg.includes('price')) {
        toast.error('‚ùå Unable to fetch current price. Please try again.', { duration: 4000 });
      } else if (error.response?.status === 400) {
        toast.error('‚ùå ' + errorMsg, { duration: 5000 });
      } else if (error.response?.status === 401) {
        toast.error('Please log in to continue');
        navigate('/login');
      } else {
        toast.error('‚ùå Failed to complete purchase. Please try again.', { duration: 4000 });
      }
    } finally {
      setProcessing(false);
      setProcessingAmount(null);
    }
  };

  return (
    <Layout>
      <div style={{ 
        padding: '2rem', 
        background: 'linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%)', 
        minHeight: '100vh',
        display: 'flex',
        alignItems: 'center',
        justifyContent: 'center'
      }}>
        <div style={{ maxWidth: '1000px', width: '100%' }}>
          {/* Header */}
          <div style={{ textAlign: 'center', marginBottom: '3rem' }}>
            <div style={{ 
              display: 'inline-flex', 
              alignItems: 'center', 
              gap: '0.5rem', 
              padding: '0.5rem 1rem',
              background: 'linear-gradient(135deg, #22C55E, #16A34A)',
              borderRadius: '20px',
              marginBottom: '1rem'
            }}>
              <Zap size={20} color="#fff" />
              <span style={{ color: '#fff', fontWeight: '700', fontSize: '14px' }}>INSTANT BUY</span>
            </div>
            <h1 style={{ fontSize: '48px', fontWeight: '900', color: '#00F0FF', marginBottom: '1rem' }}>
              Buy Crypto Instantly
            </h1>
            <p style={{ color: '#888', fontSize: '18px' }}>
              One-click purchase ‚Ä¢ No forms ‚Ä¢ Instant delivery
            </p>
          </div>

          {/* Main Card */}
          <div style={{
            background: 'rgba(15, 23, 42, 0.6)',
            border: '2px solid rgba(0, 240, 255, 0.3)',
            borderRadius: '24px',
            padding: '3rem'
          }}>
            {/* Coin Selector */}
            <div style={{ marginBottom: '2rem' }}>
              <label style={{ display: 'block', color: '#888', fontSize: '14px', marginBottom: '1rem', fontWeight: '700', textTransform: 'uppercase' }}>
                Select Cryptocurrency
              </label>
              {loading ? (
                <div style={{ textAlign: 'center', padding: '2rem', color: '#888' }}>
                  <Loader size={24} style={{ animation: 'spin 1s linear infinite' }} />
                  <div style={{ marginTop: '1rem' }}>Loading available coins...</div>
                </div>
              ) : availableCoins.length === 0 ? (
                <div style={{ 
                  textAlign: 'center', 
                  padding: '2rem', 
                  color: '#EF4444',
                  background: 'rgba(239, 68, 68, 0.1)',
                  borderRadius: '12px',
                  border: '1px solid rgba(239, 68, 68, 0.3)'
                }}>
                  <AlertCircle size={24} style={{ marginBottom: '0.5rem' }} />
                  <div>No coins available for instant buy</div>
                </div>
              ) : (
                <div style={{ 
                  display: 'grid', 
                  gridTemplateColumns: 'repeat(auto-fill, minmax(140px, 1fr))', 
                  gap: '1rem',
                  maxHeight: '300px',
                  overflowY: 'auto',
                  padding: '0.5rem'
                }}>
                  {availableCoins.map(coin => (
                    <button
                      key={coin.symbol}
                      onClick={() => setSelectedCoin(coin.symbol)}
                      disabled={processing}
                      style={{
                        padding: '1.5rem 1rem',
                        background: selectedCoin === coin.symbol 
                          ? 'linear-gradient(135deg, #00F0FF, #A855F7)' 
                          : 'rgba(255, 255, 255, 0.05)',
                        border: selectedCoin === coin.symbol ? 'none' : '1px solid rgba(255, 255, 255, 0.1)',
                        borderRadius: '12px',
                        color: selectedCoin === coin.symbol ? '#000' : '#fff',
                        fontSize: '18px',
                        fontWeight: '900',
                        cursor: processing ? 'not-allowed' : 'pointer',
                        opacity: processing ? 0.5 : 1,
                        transition: 'all 0.2s',
                        textAlign: 'center'
                      }}
                    >
                      <div style={{ marginBottom: '0.5rem' }}>{coin.symbol}</div>
                      <div style={{ fontSize: '11px', opacity: 0.8, fontWeight: '600' }}>
                        ¬£{(prices[coin.symbol] || 0).toLocaleString()}
                      </div>
                      <div style={{ fontSize: '9px', marginTop: '0.25rem', opacity: 0.6 }}>
                        Stock: {coin.available?.toFixed(4) || '0'}
                      </div>
                    </button>
                  ))}
                </div>
              )}
            </div>

            {/* Current Price Display */}
            {selectedCoin && (
              <div style={{
                padding: '1.5rem',
                background: 'rgba(0, 240, 255, 0.1)',
                border: '1px solid rgba(0, 240, 255, 0.3)',
                borderRadius: '12px',
                marginBottom: '2rem',
                textAlign: 'center'
              }}>
                <div style={{ color: '#888', fontSize: '12px', marginBottom: '0.5rem' }}>CURRENT PRICE</div>
                <div style={{ fontSize: '32px', fontWeight: '900', color: '#00F0FF' }}>
                  ¬£{(prices[selectedCoin] || 0).toLocaleString()}
                </div>
                <div style={{ color: '#22C55E', fontSize: '14px', marginTop: '0.5rem', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.25rem' }}>
                  <TrendingUp size={16} />
                  Live Price
                </div>
              </div>
            )}

            {/* Preset Amount Buttons */}
            <div style={{ marginBottom: '2rem' }}>
              <label style={{ display: 'block', color: '#888', fontSize: '14px', marginBottom: '1rem', fontWeight: '700', textTransform: 'uppercase' }}>
                Choose Amount (GBP)
              </label>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem' }}>
                {presetAmounts.map(amount => {
                  const cryptoAmount = selectedCoin && prices[selectedCoin] 
                    ? (amount / prices[selectedCoin]).toFixed(8) 
                    : '0';
                  const isProcessingThis = processing && processingAmount === amount;
                  
                  return (
                    <button
                      key={amount}
                      onClick={() => handleFastBuy(amount)}
                      disabled={processing || !selectedCoin}
                      style={{
                        padding: '2rem 1rem',
                        background: isProcessingThis 
                          ? 'linear-gradient(135deg, #16A34A, #15803D)'
                          : processing || !selectedCoin
                          ? 'rgba(34, 197, 94, 0.3)'
                          : 'linear-gradient(135deg, #22C55E, #16A34A)',
                        border: 'none',
                        borderRadius: '16px',
                        color: '#fff',
                        cursor: processing || !selectedCoin ? 'not-allowed' : 'pointer',
                        opacity: processing && !isProcessingThis ? 0.3 : 1,
                        transition: 'all 0.3s',
                        position: 'relative'
                      }}
                    >
                      {isProcessingThis ? (
                        <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '0.5rem' }}>
                          <Loader size={24} style={{ animation: 'spin 1s linear infinite' }} />
                          <div style={{ fontSize: '14px' }}>Processing...</div>
                        </div>
                      ) : (
                        <>
                          <div style={{ fontSize: '32px', fontWeight: '900', marginBottom: '0.5rem' }}>
                            ¬£{amount}
                          </div>
                          <div style={{ fontSize: '14px', opacity: 0.9 }}>
                            ‚âà {cryptoAmount} {selectedCoin || '---'}
                          </div>
                        </>
                      )}
                    </button>
                  );
                })}
              </div>
            </div>

            {/* Info Box */}
            <div style={{
              padding: '1rem',
              background: 'rgba(34, 197, 94, 0.1)',
              border: '1px solid rgba(34, 197, 94, 0.3)',
              borderRadius: '8px',
              fontSize: '13px',
              color: '#888',
              lineHeight: '1.6'
            }}>
              <strong style={{ color: '#22C55E' }}>‚úì Instant Delivery</strong> ‚Ä¢ Crypto delivered to your wallet immediately<br/>
              <strong style={{ color: '#22C55E' }}>‚úì No Escrow Wait</strong> ‚Ä¢ Buy directly from platform liquidity<br/>
              <strong style={{ color: '#22C55E' }}>‚úì Best Price</strong> ‚Ä¢ Live market rates with small platform fee
            </div>
          </div>
        </div>
      </div>
    </Layout>
  );
}

export default InstantBuy;
