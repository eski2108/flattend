<analysis>**original_problem_statement**: The user's initial request was a comprehensive frontend UX overhaul to eliminate visual jitter and slow-loading icons/emojis on the Dashboard, Wallet, and Instant Buy pages. After this was completed and signed off, the user pivoted to a new, higher-priority set of tasks focused on core safety, control, and production readiness.

This new set of requirements was broken down into a strict priority order (P0, P1, P2).

**PRODUCT REQUIREMENTS (P0 - CRITICAL - COMPLETE):**
1.  **Freeze User Account**: Ability for an admin to freeze a user, blocking login, trading, and withdrawals. Must be fully audited.
2.  **Freeze Wallet**: Ability for an admin to freeze a specific wallet (asset) for a user, blocking all value-moving actions from that wallet.
3.  **Double-click/Duplicate Protection**: Implement backend-authoritative idempotency for all value-moving actions (withdrawals, swaps, buys, trades) using a client-sent  header, paired with a frontend debounce mechanism.
4.  **Manual Balance Adjustment**: A dedicated, audited admin endpoint to credit/debit user balances with a mandatory reason. Must handle freeze states and prevent negative balances.

**PRODUCT REQUIREMENTS (P1 - HIGH PRIORITY - IN PROGRESS):**
1.  **Force Logout / Session Revocation**: Admin endpoint to revoke all active sessions for a user, which must also trigger automatically when a user is frozen.
2.  **Complete Admin Action Audit**: Ensure every admin action is logged with a consistent, detailed format.
3.  **Feature Flags / Kill Switches**: A DB-driven system to instantly toggle major features (withdrawals, swaps, signups, etc.) on/off without a redeploy. (This part of P1 was prioritized and is complete).

**User's preferred language**: English. The user is highly technical, direct, and demands strict adherence to their specified requirements and priority order. All implementations must be non-negotiable and proven with evidence (JSON responses, audit logs, screenshots). The next agent must respond with precision and provide clear proof for all completed work.

**what currently exists?**
- A high-performance frontend with optimized icon/asset loading () and zero layout shift (CLS=0) on key pages, a milestone that has been formally signed off by the user.
- A robust set of P0 admin safety controls are fully implemented and pushed to all repositories.
- **Freeze System**: Admins can freeze/unfreeze entire user accounts or individual wallets, blocking all relevant financial operations. All actions are fully audited.
- **Idempotency Service**: A backend service () prevents duplicate processing of financial transactions (withdraw, swap, buy, trade) using client-sent keys and atomic database operations. A corresponding frontend hook () and button component () provide UI debouncing.
- **Manual Balance Adjustment System**: A dedicated, idempotent, and fully audited admin endpoint allows for manual credits/debits to user balances, with safety checks for negative balances and freeze states.
- **Feature Flag / Kill Switch System**: A DB-driven service () allows admins to instantly enable/disable core platform features (withdrawals, swaps, P2P, etc.) without redeploying. All changes are audited.

**Last working item**:
-   **Last item agent was working**: The agent was beginning the implementation of the Force Logout / Session Revocation feature, which is the next task in the P1 priority list.
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: Backend testing agent or  to test the new session revocation endpoints and verify that a user with a revoked session is blocked from making authenticated requests.
-   **User Testing Done**: N

**All Pending/In progress Issue list**:
- There are no outstanding bugs or issues. The agent is executing a planned task list.

**In progress Task List**:
-   **Task 1: Complete P1 Task: Force Logout / Session Revocation (P0)**
    -   **Where to resume**: The agent has just created the foundational file . The next steps are:
        1.  Flesh out  with logic to store, validate, and revoke user sessions (e.g., using a new  MongoDB collection).
        2.  Create new admin endpoints in  (e.g., ) that use this service.
        3.  Modify the Freeze User endpoint () to automatically call the new session revocation service.
        4.  Integrate a session validation check into the core authentication middleware to ensure revoked sessions are immediately blocked.
        5.  Add comprehensive audit logging for all session revocation actions.
    -   **What will be achieved with this?**: This will provide a critical security control, allowing admins to immediately terminate a user's access across all devices, and will automatically enforce this upon freezing an account.
    -   **Status**: IN PROGRESS
    -   **Should Test frontend/backend/both after fix?**: Backend
    -   **Blocked on something**: None

**Upcoming and Future Tasks**
-   **Upcoming Tasks**:
    -   **P1: Complete Admin Action Audit (P1)**: After Force Logout is done, the agent must review all admin endpoints and ensure every single one has consistent, detailed audit logging matching the standard set in P0.
-   **Future Tasks**:
    -   **P2: Transaction Rollback / Recovery (P2)**: Implement a clear state machine for transactions to handle partial failures gracefully (e.g.,  states).
    -   **P2: On-chain Reconciliation (P2)**: Create a periodic, read-only job to compare internal ledger balances against on-chain balances and alert on any discrepancies.
    -   **Implement SMS 2FA Login Flow**: This was an original request but was deprioritized. It is blocked by potentially invalid Twilio credentials that need user verification.
    -   **Add instructions in the dashboard**: This was a vague, low-priority user request that still requires clarification.

**Completed work in this session**
-   **Frontend UX & Performance Overhaul (DONE & SIGNED OFF)**
    -   Rewrote  (v2) to eliminate layout shift and icon pop-in.
    -   Added global CSS in  for layout stability.
    -   Locked down the implementation by deprecating legacy components and adding ESLint rules.
    -   Provided a full proof bundle with metrics (CLS=0), screenshots, and commit IDs.
-   **P0-1: Freeze User Account (DONE)**: Implemented endpoints and logic to freeze/unfreeze user accounts, blocking all critical actions. Fully audited.
-   **P0-2: Freeze Wallet (DONE)**: Implemented endpoints and logic to freeze/unfreeze specific asset wallets for a user. Fully audited.
-   **P0-3: Double-click/Duplicate Protection (DONE)**: Created  and protected all value-moving endpoints against duplicate requests.
-   **P0-4: Manual Balance Adjustment (DONE)**: Implemented a dedicated, audited admin endpoint for adjusting user balances with strict safety checks.
-   **P1: Feature Flags / Kill Switches (DONE)**: Created  and admin endpoints to toggle all core platform features on/off instantly.

**Earlier issues found/mentioned but not fixed**
-   **Issue 1: Invalid Twilio Credentials**
    -   **Debug checklist**: The SMS 2FA feature is blocked because the Twilio credentials in  likely cause a 401 Authentication Error. The next agent must ask the user to verify the Account SID and Auth Token before attempting to work on the 2FA feature.
    -   **Why to solve this issue and what will be achieved with this?**: This is a required security feature that cannot be implemented until the credentials are confirmed to be valid.
    -   **Should Test frontend/backend/both after fix**: Backend
    -   **Is recurring issue?**: Y

**Known issue recurrence from previous fork**
-   **Issue recurrence in previous fork**: Massive, single-file backend () is prone to syntax errors that are hard to debug because they can prevent new routes from being registered without crashing the server.
-   **Recurrence count**: Occurred once during this session (Message 336), blocking progress for a significant time.
-   **Status**: RESOLVED (for now). The agent fixed the syntax error. The next agent must be vigilant and run a syntax check () after modifying this file.

**Code Architecture**


**Key Technical Concepts**
-   **Idempotency-as-a-Service**: A centralized backend service () that uses a dedicated MongoDB collection () with a unique compound index (, , ) and a TTL to ensure financial operations are processed only once.
-   **DB-Driven Feature Flags**: A backend service () that stores feature toggles in MongoDB, allowing for real-time enabling/disabling of platform features without redeployment. Uses caching with a short TTL for performance and instant cache invalidation on updates.
-   **Admin Control Systems**: A suite of admin-only, fully audited endpoints for critical safety functions, including freezing users/wallets and performing manual balance adjustments. These systems are built with strict safety rules (e.g., no negative balances, freeze overrides).
-   **Frontend Performance Optimization**: The  component was rewritten to use fixed-size containers, concurrent text/image rendering with CSS opacity transitions, and image preloading to achieve a Cumulative Layout Shift (CLS) score of 0.

**key DB schema**
-   **idempotency_keys**: 
-   **feature_flags**: 
-   **balance_adjustments**: 
-   **admin_audit_logs**: Generic collection for logging all admin actions (freeze, unfreeze, flag changes, adjustments, etc.).
-   **users/user_accounts**: Added , , ,  fields.
-   **wallets**: Added , , , ,  to the document for each asset.

**All files of reference**
-   : The main monolith file where all new endpoints and enforcement checks were added.
-   : (NEW) The authoritative service for preventing duplicate transactions.
-   : (NEW) The authoritative service for managing kill switches.
-   : (NEW & IN-PROGRESS) The file where the next task will be implemented.
-   : The file at the core of the completed UI/UX overhaul.

**Critical Info for New Agent**
1.  **ADHERE TO PRIORITY**: The user has defined a strict P0 -> P1 -> P2 priority list. DO NOT deviate. Your next task is to complete the Force Logout implementation, followed by Complete Admin Action Audit.
2.  **PROVIDE PROOF BUNDLES**: For every completed task, the user expects a proof bundle including JSON responses, audit log excerpts, and confirmation of commit/push. Follow the pattern established in the chat history.
3.  **MONOLITH SERVER FILE**: The backend logic resides almost entirely in . It is extremely large and fragile. After any modification, **you must run a syntax check () before restarting the server** to avoid hard-to-debug route registration failures.
4.  **TWO USER COLLECTIONS**: Be aware that user data is split across two collections:  and . All user-related queries must check both collections to find a user. This was a major source of bugs.

**Last 10 User Messages and any pending HUMAN messages**
1.  **User**: Signed off on P0. Provided detailed requirements for the remaining P1 items: **1. Force Logout / Session Revocation**, and **2. Complete Admin Action Audit**. Instructed the agent to proceed in that order and provide proof for each.

**Project Health Check:**
-   **Broken**: The SMS 2FA flow is completely unimplemented on the frontend and the backend is likely broken due to invalid Twilio credentials.
-   **Mocked**: None.

**3rd Party Integrations**
-   **Twilio**: For SMS 2FA. **(CURRENTLY UNSTABLE/BROKEN - requires user to verify credentials)**.
-   **CoinGecko**: Live cryptocurrency prices.
-   **NOWPayments**: List of supported currencies.
-   **TradingView**: Candlestick charts.
-   **Resend/SendGrid**: Email services.
-   **Google OAuth**: For login.

**Testing status**
-   **Testing agent used after significant changes**: YES, a testing agent was used to verify the initial UI/UX fixes.
-   **Troubleshoot agent used after agent stuck in loop**: NO.
-   **Test files created**: None. Test scripts were run directly via shell commands.
-   **Known regressions**: None.

**Credentials to test flow:**
-   **Admin User**:  (used for audit logs). Login flow for this user not shown.
-   **Test User**:  (from  collection in production DB).
-   **Twilio Auth Token**: Likely invalid and the source of the 2FA issue.

**What agent forgot to execute**
- The agent has been following the user's reprioritization perfectly. The original requests for SMS 2FA and dashboard instructions have been correctly placed on the back burner in favor of the critical P0/P1 safety and control features.</analysis>
