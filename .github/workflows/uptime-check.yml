name: Site Health Check

# Runs every 30 minutes as backup to UptimeRobot
on:
  schedule:
    - cron: '*/30 * * * *'
  workflow_dispatch:

env:
  SITE_URL: ${{ secrets.TEST_URL }}

jobs:
  health-check:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Check Site Status
        id: health
        run: |
          if [ -z "$SITE_URL" ]; then
            echo "âš ï¸ TEST_URL not configured, skipping health check"
            exit 0
          fi
          
          echo "Checking: $SITE_URL"
          
          HTTP_CODE=$(curl -sS -o /dev/null -w "%{http_code}" --connect-timeout 30 --max-time 60 "$SITE_URL" || echo "000")
          
          echo "HTTP Status: $HTTP_CODE"
          echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 400 ]; then
            echo "âœ… Site is UP"
            echo "status=up" >> $GITHUB_OUTPUT
          else
            echo "âŒ Site is DOWN or unreachable"
            echo "status=down" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Alert Slack on Down
        if: failure() && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{
              "text": "ðŸš¨ *SITE DOWN ALERT*\n\nCoinHubX is unreachable!\n\nURL: '"$SITE_URL"'\nHTTP Code: '"${{ steps.health.outputs.http_code }}"'\nTime: '"$(date -u)"'\n\nPlease investigate immediately!"
            }' \
            "$SLACK_WEBHOOK_URL"

      - name: Log Success
        if: success()
        run: |
          echo "=============================="
          echo "Site: $SITE_URL"
          echo "Status: UP âœ…"
          echo "Checked: $(date -u)"
          echo "=============================="
