import React, { useState, useEffect, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import axios from 'axios';
import { toast } from 'sonner';

const API = process.env.REACT_APP_BACKEND_URL;

export default function SpotTradingPro() {
  const navigate = useNavigate();
  const chartContainerRef = useRef(null);
  const [user, setUser] = useState(null);
  const [selectedPair, setSelectedPair] = useState('BTC/GBP');
  const [selectedTimeframe, setSelectedTimeframe] = useState('1h');
  const [orderType, setOrderType] = useState('market');
  const [side, setSide] = useState('buy');
  const [amount, setAmount] = useState('');
  const [price, setPrice] = useState('');
  const [total, setTotal] = useState('');
  const [currentPrice, setCurrentPrice] = useState(0);
  const [balances, setBalances] = useState({});
  const [fee, setFee] = useState(0);

  const timeframes = ['1m', '5m', '15m', '1h', '4h', '1D'];

  // All trading pairs
  const pairs = [
    { symbol: 'ADA/GBP', base: 'ADA', quote: 'GBP', change: '+0.00%' },
    { symbol: 'ADA/USDT', base: 'ADA', quote: 'USDT', change: '+0.00%' },
    { symbol: 'BCH/GBP', base: 'BCH', quote: 'GBP', change: '+0.00%' },
    { symbol: 'BCH/USDT', base: 'BCH', quote: 'USDT', change: '+0.00%' },
    { symbol: 'BNB/GBP', base: 'BNB', quote: 'GBP', change: '+0.00%' },
    { symbol: 'BNB/USDT', base: 'BNB', quote: 'USDT', change: '+0.00%' },
    { symbol: 'BTC/GBP', base: 'BTC', quote: 'GBP', change: '+0.00%' },
    { symbol: 'BTC/USDT', base: 'BTC', quote: 'USDT', change: '+0.00%' },
    { symbol: 'DOGE/GBP', base: 'DOGE', quote: 'GBP', change: '+0.00%' },
    { symbol: 'ETH/GBP', base: 'ETH', quote: 'GBP', change: '+0.00%' },
    { symbol: 'LTC/GBP', base: 'LTC', quote: 'GBP', change: '+0.00%' },
    { symbol: 'SOL/GBP', base: 'SOL', quote: 'GBP', change: '+0.00%' },
    { symbol: 'XRP/GBP', base: 'XRP', quote: 'GBP', change: '+0.00%' },
  ];

  useEffect(() => {
    const userData = localStorage.getItem('cryptobank_user');
    if (!userData) {
      navigate('/login');
      return;
    }
    setUser(JSON.parse(userData));
    loadBalances();
  }, [navigate]);

  useEffect(() => {
    if (chartContainerRef.current && window.TradingView) {
      new window.TradingView.widget({
        autosize: true,
        symbol: selectedPair.replace('/', ''),
        interval: selectedTimeframe === '1m' ? '1' : selectedTimeframe === '5m' ? '5' : selectedTimeframe === '15m' ? '15' : selectedTimeframe === '1h' ? '60' : selectedTimeframe === '4h' ? '240' : 'D',
        timezone: 'Etc/UTC',
        theme: 'dark',
        style: '1',
        locale: 'en',
        toolbar_bg: '#0A1628',
        enable_publishing: false,
        hide_side_toolbar: false,
        allow_symbol_change: false,
        container_id: 'tradingview_chart',
        studies: ['RSI@tv-basicstudies', 'MACD@tv-basicstudies'],
        backgroundColor: '#0A1628',
        gridColor: 'rgba(0,255,255,0.05)',
      });
    }
  }, [selectedPair, selectedTimeframe]);

  useEffect(() => {
    fetchCurrentPrice();
    const interval = setInterval(fetchCurrentPrice, 5000);
    return () => clearInterval(interval);
  }, [selectedPair]);

  useEffect(() => {
    if (orderType === 'market' && amount) {
      const calculatedTotal = (parseFloat(amount) * currentPrice).toFixed(2);
      setTotal(calculatedTotal);
      calculateFee(calculatedTotal);
    } else if (orderType === 'limit' && amount && price) {
      const calculatedTotal = (parseFloat(amount) * parseFloat(price)).toFixed(2);
      setTotal(calculatedTotal);
      calculateFee(calculatedTotal);
    }
  }, [amount, price, currentPrice, orderType]);

  const loadBalances = async () => {
    if (!user) return;
    try {
      const res = await axios.get(`${API}/api/user/${user.user_id}/portfolio`);
      if (res.data.success && res.data.balances) {
        const balObj = {};
        res.data.balances.forEach(b => {
          balObj[b.currency] = b.balance;
        });
        setBalances(balObj);
      }
    } catch (error) {
      console.error('Failed to load balances:', error);
    }
  };

  const fetchCurrentPrice = async () => {
    try {
      const [base, quote] = selectedPair.split('/');
      const res = await axios.get(`${API}/api/prices/${base}`);
      if (res.data.success && res.data.prices && res.data.prices[quote]) {
        setCurrentPrice(res.data.prices[quote]);
        if (orderType === 'market') {
          setPrice(res.data.prices[quote]);
        }
      }
    } catch (error) {
      console.error('Failed to fetch price:', error);
    }
  };

  const calculateFee = (totalAmount) => {
    const feeAmount = parseFloat(totalAmount) * 0.001;
    setFee(feeAmount.toFixed(2));
  };

  const handleTrade = async () => {
    if (!amount || parseFloat(amount) <= 0) {
      toast.error('Please enter a valid amount');
      return;
    }

    if (orderType === 'limit' && (!price || parseFloat(price) <= 0)) {
      toast.error('Please enter a valid price');
      return;
    }

    try {
      const [base, quote] = selectedPair.split('/');
      const tradeData = {
        user_id: user.user_id,
        from_currency: side === 'buy' ? quote : base,
        to_currency: side === 'buy' ? base : quote,
        from_amount: side === 'buy' ? parseFloat(total) : parseFloat(amount),
        order_type: orderType,
        limit_price: orderType === 'limit' ? parseFloat(price) : null
      };

      const res = await axios.post(`${API}/api/trading/spot-trade`, tradeData);
      
      if (res.data.success) {
        toast.success(`${side.toUpperCase()} order executed successfully!`);
        setAmount('');
        setPrice('');
        setTotal('');
        loadBalances();
      } else {
        toast.error(res.data.message || 'Trade failed');
      }
    } catch (error) {
      toast.error(error.response?.data?.message || 'Trade failed');
    }
  };

  return (
    <div style={{
      background: '#0A1628',
      minHeight: '100vh',
      padding: '0'
    }}>
        {/* Top Bar with Pair Title and Timeframes */}
        <div style={{
          background: '#07111C',
          borderBottom: '1px solid rgba(0,255,207,0.2)',
          padding: '16px 20px',
          display: 'flex',
          justifyContent: 'space-between',
          alignItems: 'center'
        }}>
          <h1 style={{
            fontSize: '24px',
            fontWeight: '700',
            color: '#fff',
            margin: 0,
            textShadow: '0 0 10px rgba(0,255,207,0.6)'
          }}>
            {selectedPair}
          </h1>

          {/* Timeframes */}
          <div style={{ display: 'flex', gap: '8px' }}>
            {timeframes.map((tf) => (
              <button
                key={tf}
                onClick={() => setSelectedTimeframe(tf)}
                style={{
                  padding: '8px 16px',
                  background: selectedTimeframe === tf ? '#0FFFCF' : '#0D1B2A',
                  color: selectedTimeframe === tf ? '#000' : '#8FA3C7',
                  border: 'none',
                  borderRadius: '8px',
                  fontWeight: '600',
                  fontSize: '14px',
                  cursor: 'pointer',
                  transition: 'all 0.2s',
                  boxShadow: selectedTimeframe === tf ? '0 0 15px rgba(15,255,207,0.5)' : 'none'
                }}
              >
                {tf}
              </button>
            ))}
          </div>
        </div>

        {/* Main 3-Column Layout */}
        <div style={{
          display: 'grid',
          gridTemplateColumns: '280px 1fr 380px',
          height: 'calc(100vh - 140px)',
          gap: '0'
        }}>
          {/* LEFT COLUMN - Trading Pairs Panel */}
          <div style={{
            background: '#07111C',
            borderRight: '1px solid rgba(0,255,207,0.2)',
            overflowY: 'auto',
            padding: '16px'
          }}>
            <div style={{
              fontSize: '16px',
              fontWeight: '700',
              color: '#fff',
              marginBottom: '16px',
              paddingBottom: '12px',
              borderBottom: '1px solid rgba(0,255,207,0.2)'
            }}>
              Trading Pairs
            </div>

            {pairs.map((pair) => {
              const isActive = selectedPair === pair.symbol;
              const isPositive = pair.change.startsWith('+');
              
              return (
                <div
                  key={pair.symbol}
                  onClick={() => setSelectedPair(pair.symbol)}
                  style={{
                    padding: '12px',
                    marginBottom: '8px',
                    background: isActive ? 'rgba(15,255,207,0.15)' : 'rgba(13,27,42,0.5)',
                    border: isActive ? '1px solid #0FFFCF' : '1px solid rgba(0,255,207,0.1)',
                    borderRadius: '8px',
                    cursor: 'pointer',
                    transition: 'all 0.2s',
                    boxShadow: isActive ? '0 0 15px rgba(15,255,207,0.4)' : 'none',
                    display: 'flex',
                    justifyContent: 'space-between',
                    alignItems: 'center'
                  }}
                  onMouseEnter={(e) => {
                    if (!isActive) {
                      e.currentTarget.style.background = 'rgba(15,255,207,0.08)';
                      e.currentTarget.style.borderColor = 'rgba(0,255,207,0.3)';
                    }
                  }}
                  onMouseLeave={(e) => {
                    if (!isActive) {
                      e.currentTarget.style.background = 'rgba(13,27,42,0.5)';
                      e.currentTarget.style.borderColor = 'rgba(0,255,207,0.1)';
                    }
                  }}
                >
                  <div style={{
                    display: 'flex',
                    alignItems: 'center',
                    gap: '10px'
                  }}>
                    <div style={{
                      width: '32px',
                      height: '32px',
                      borderRadius: '50%',
                      background: 'linear-gradient(135deg, #0FFFCF, #00BFFF)',
                      display: 'flex',
                      alignItems: 'center',
                      justifyContent: 'center',
                      fontSize: '14px',
                      fontWeight: '700',
                      color: '#000'
                    }}>
                      {pair.base.charAt(0)}
                    </div>
                    <div>
                      <div style={{ fontWeight: '600', color: '#fff', fontSize: '14px' }}>{pair.symbol}</div>
                      <div style={{ fontSize: '11px', color: '#8FA3C7' }}>Vol: --</div>
                    </div>
                  </div>
                  <div style={{ textAlign: 'right' }}>
                    <div style={{ fontSize: '12px', fontWeight: '600', color: isPositive ? '#00FFA8' : '#FF4A6B' }}>
                      {pair.change}
                    </div>
                  </div>
                </div>
              );
            })}
          </div>

          {/* CENTER COLUMN - TradingView Chart */}
          <div style={{
            background: '#0A1628',
            padding: '16px',
            position: 'relative'
          }}>
            <div 
              id="tradingview_chart" 
              ref={chartContainerRef}
              style={{
                width: '100%',
                height: '100%',
                borderRadius: '8px',
                overflow: 'hidden'
              }}
            />
          </div>

          {/* RIGHT COLUMN - Buy/Sell Panel */}
          <div style={{
            background: '#07111C',
            borderLeft: '1px solid rgba(0,255,207,0.2)',
            padding: '20px',
            display: 'flex',
            flexDirection: 'column'
          }}>
            {/* BUY/SELL Tabs */}
            <div style={{
              display: 'grid',
              gridTemplateColumns: '1fr 1fr',
              gap: '8px',
              marginBottom: '20px'
            }}>
              <button
                onClick={() => setSide('buy')}
                style={{
                  padding: '14px',
                  background: side === 'buy' ? '#00FFA8' : '#0D1B2A',
                  color: side === 'buy' ? '#000' : '#8FA3C7',
                  border: 'none',
                  borderRadius: '10px',
                  fontWeight: '700',
                  fontSize: '16px',
                  cursor: 'pointer',
                  boxShadow: side === 'buy' ? '0 0 20px rgba(0,255,168,0.6)' : 'none',
                  transition: 'all 0.2s'
                }}
              >
                BUY
              </button>
              <button
                onClick={() => setSide('sell')}
                style={{
                  padding: '14px',
                  background: side === 'sell' ? '#00BFFF' : '#0D1B2A',
                  color: side === 'sell' ? '#000' : '#8FA3C7',
                  border: 'none',
                  borderRadius: '10px',
                  fontWeight: '700',
                  fontSize: '16px',
                  cursor: 'pointer',
                  boxShadow: side === 'sell' ? '0 0 20px rgba(0,191,255,0.6)' : 'none',
                  transition: 'all 0.2s'
                }}
              >
                SELL
              </button>
            </div>

            {/* MARKET/LIMIT Toggle */}
            <div style={{
              display: 'flex',
              gap: '8px',
              marginBottom: '20px'
            }}>
              <button
                onClick={() => setOrderType('market')}
                style={{
                  flex: 1,
                  padding: '12px',
                  background: orderType === 'market' ? '#0FFFCF' : '#0D1B2A',
                  color: orderType === 'market' ? '#000' : '#8FA3C7',
                  border: 'none',
                  borderRadius: '8px',
                  fontWeight: '600',
                  cursor: 'pointer'
                }}
              >
                MARKET
              </button>
              <button
                onClick={() => setOrderType('limit')}
                style={{
                  flex: 1,
                  padding: '12px',
                  background: orderType === 'limit' ? '#0FFFCF' : '#0D1B2A',
                  color: orderType === 'limit' ? '#000' : '#8FA3C7',
                  border: 'none',
                  borderRadius: '8px',
                  fontWeight: '600',
                  cursor: 'pointer'
                }}
              >
                LIMIT
              </button>
            </div>

            {/* Amount Input */}
            <div style={{ marginBottom: '16px' }}>
              <label style={{
                display: 'block',
                color: '#8FA3C7',
                fontSize: '13px',
                marginBottom: '8px',
                fontWeight: '600'
              }}>
                Amount
              </label>
              <input
                type="number"
                value={amount}
                onChange={(e) => setAmount(e.target.value)}
                placeholder="0.00"
                style={{
                  width: '100%',
                  padding: '14px',
                  background: '#0D1B2A',
                  border: '1px solid rgba(15,255,207,0.3)',
                  borderRadius: '8px',
                  color: '#fff',
                  fontSize: '16px',
                  outline: 'none',
                  boxShadow: '0 0 10px rgba(15,255,207,0.1)'
                }}
              />
            </div>

            {/* Price Input (Limit only) */}
            {orderType === 'limit' && (
              <div style={{ marginBottom: '16px' }}>
                <label style={{
                  display: 'block',
                  color: '#8FA3C7',
                  fontSize: '13px',
                  marginBottom: '8px',
                  fontWeight: '600'
                }}>
                  Price
                </label>
                <input
                  type="number"
                  value={price}
                  onChange={(e) => setPrice(e.target.value)}
                  placeholder="0.00"
                  style={{
                    width: '100%',
                    padding: '14px',
                    background: '#0D1B2A',
                    border: '1px solid rgba(15,255,207,0.3)',
                    borderRadius: '8px',
                    color: '#fff',
                    fontSize: '16px',
                    outline: 'none',
                    boxShadow: '0 0 10px rgba(15,255,207,0.1)'
                  }}
                />
              </div>
            )}

            {/* Total */}
            <div style={{ marginBottom: '16px' }}>
              <label style={{
                display: 'block',
                color: '#8FA3C7',
                fontSize: '13px',
                marginBottom: '8px',
                fontWeight: '600'
              }}>
                Total
              </label>
              <input
                type="text"
                value={total}
                readOnly
                placeholder="0.00"
                style={{
                  width: '100%',
                  padding: '14px',
                  background: '#0D1B2A',
                  border: '1px solid rgba(15,255,207,0.3)',
                  borderRadius: '8px',
                  color: '#0FFFCF',
                  fontSize: '16px',
                  outline: 'none'
                }}
              />
            </div>

            {/* Fee Display */}
            <div style={{
              marginBottom: '20px',
              padding: '12px',
              background: 'rgba(15,255,207,0.05)',
              borderRadius: '8px',
              border: '1px solid rgba(15,255,207,0.2)'
            }}>
              <div style={{ fontSize: '13px', color: '#8FA3C7', marginBottom: '4px' }}>
                Available: {balances[side === 'buy' ? 'GBP' : selectedPair.split('/')[0]] || 0} {side === 'buy' ? 'GBP' : selectedPair.split('/')[0]}
              </div>
              <div style={{ fontSize: '13px', color: '#0FFFCF', fontWeight: '600' }}>
                Fee: {fee} GBP (0.1%)
              </div>
            </div>

            {/* Main Trade Button */}
            <button
              onClick={handleTrade}
              style={{
                width: '100%',
                padding: '18px',
                background: side === 'buy' ? '#00FFA8' : '#00BFFF',
                color: '#000',
                border: 'none',
                borderRadius: '12px',
                fontWeight: '700',
                fontSize: '18px',
                cursor: 'pointer',
                boxShadow: side === 'buy' ? '0 4px 20px rgba(0,255,168,0.5)' : '0 4px 20px rgba(0,191,255,0.5)',
                transition: 'all 0.2s',
                marginBottom: '16px'
              }}
              onMouseEnter={(e) => {
                e.currentTarget.style.transform = 'translateY(-2px)';
                e.currentTarget.style.boxShadow = side === 'buy' 
                  ? '0 6px 25px rgba(0,255,168,0.7)' 
                  : '0 6px 25px rgba(0,191,255,0.7)';
              }}
              onMouseLeave={(e) => {
                e.currentTarget.style.transform = 'translateY(0)';
                e.currentTarget.style.boxShadow = side === 'buy' 
                  ? '0 4px 20px rgba(0,255,168,0.5)' 
                  : '0 4px 20px rgba(0,191,255,0.5)';
              }}
            >
              {side === 'buy' ? 'BUY' : 'SELL'} {selectedPair.split('/')[0]}
            </button>

            {/* Deposit & Withdrawal Buttons */}
            <div style={{
              display: 'grid',
              gridTemplateColumns: '1fr 1fr',
              gap: '8px',
              marginTop: 'auto'
            }}>
              <button
                onClick={() => navigate('/wallet')}
                style={{
                  padding: '12px',
                  background: 'transparent',
                  border: '1px solid #0FFFCF',
                  borderRadius: '10px',
                  color: '#0FFFCF',
                  fontWeight: '600',
                  fontSize: '14px',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = 'rgba(15,255,207,0.1)';
                  e.currentTarget.style.boxShadow = '0 0 15px rgba(15,255,207,0.4)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'transparent';
                  e.currentTarget.style.boxShadow = 'none';
                }}
              >
                Deposit
              </button>
              <button
                onClick={() => navigate('/wallet')}
                style={{
                  padding: '12px',
                  background: 'transparent',
                  border: '1px solid #0FFFCF',
                  borderRadius: '10px',
                  color: '#0FFFCF',
                  fontWeight: '600',
                  fontSize: '14px',
                  cursor: 'pointer',
                  transition: 'all 0.2s'
                }}
                onMouseEnter={(e) => {
                  e.currentTarget.style.background = 'rgba(15,255,207,0.1)';
                  e.currentTarget.style.boxShadow = '0 0 15px rgba(15,255,207,0.4)';
                }}
                onMouseLeave={(e) => {
                  e.currentTarget.style.background = 'transparent';
                  e.currentTarget.style.boxShadow = 'none';
                }}
              >
                Withdraw
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}