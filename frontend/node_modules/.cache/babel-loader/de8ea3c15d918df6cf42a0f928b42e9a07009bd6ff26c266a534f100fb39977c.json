{"ast":null,"code":"import React,{useEffect,useState}from'react';import{useNavigate,useLocation}from'react-router-dom';import Layout from'@/components/Layout';import{Button}from'@/components/ui/button';import{Input}from'@/components/ui/input';import{IoCard,IoCheckmarkCircle as CheckCircle2,IoShield,IoStar}from'react-icons/io5';import axios from'axios';import{toast}from'sonner';import DualCurrencyInput from'@/components/DualCurrencyInput';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const BACKEND_URL=process.env.REACT_APP_BACKEND_URL;const API=BACKEND_URL;export default function OrderPreview(){var _location$state,_offer$seller_name,_offer$price_per_unit,_offer$payment_method;const location=useLocation();const navigate=useNavigate();const offer=((_location$state=location.state)===null||_location$state===void 0?void 0:_location$state.offer)||null;const[cryptoAmount,setCryptoAmount]=useState('');const[fiatAmount,setFiatAmount]=useState('');const[processing,setProcessing]=useState(false);const[currentUser,setCurrentUser]=useState(null);// NEW: Wallet address fields\nconst[walletAddress,setWalletAddress]=useState('');const[walletNetwork,setWalletNetwork]=useState('');const[walletValidation,setWalletValidation]=useState(null);const[validatingWallet,setValidatingWallet]=useState(false);const[isMobile,setIsMobile]=useState(window.innerWidth<=768);// Handle window resize for mobile responsiveness\nuseEffect(()=>{const handleResize=()=>setIsMobile(window.innerWidth<=768);window.addEventListener('resize',handleResize);return()=>window.removeEventListener('resize',handleResize);},[]);useEffect(()=>{const userData=localStorage.getItem('cryptobank_user');if(!userData){navigate('/login');return;}const user=JSON.parse(userData);setCurrentUser(user);if(!offer){toast.error('No offer data received');navigate('/p2p-marketplace');return;}if(!offer.min_purchase||!offer.max_purchase||!offer.price_per_unit){toast.error('Invalid or incomplete offer data');navigate('/p2p-marketplace');return;}// Set default to mid-range\nconst midCrypto=(offer.min_purchase+offer.max_purchase)/2;const midFiat=(midCrypto*offer.price_per_unit).toFixed(2);setCryptoAmount(midCrypto.toFixed(8));setFiatAmount(midFiat);},[offer,navigate]);const handleFiatInputChange=value=>{setFiatAmount(value);if(value&&offer&&parseFloat(value)>0){const crypto=parseFloat(value)/offer.price_per_unit;setCryptoAmount(crypto.toFixed(8));}else{setCryptoAmount('');}};const handleCryptoInputChange=value=>{setCryptoAmount(value);if(value&&offer&&parseFloat(value)>0){const fiat=parseFloat(value)*offer.price_per_unit;setFiatAmount(fiat.toFixed(2));}else{setFiatAmount('');}};const getCurrencySymbol=currency=>{const symbols={'USD':'$','GBP':'£','EUR':'€'};return symbols[currency]||'$';};// NEW: Validate wallet address (optional, non-blocking)\nconst validateWalletAddress=async()=>{if(!walletAddress.trim()){return;}setValidatingWallet(true);try{const response=await axios.post(\"\".concat(API,\"/api/wallet/validate\"),null,{params:{address:walletAddress,cryptocurrency:offer.crypto_currency,network:walletNetwork||null}});if(response.data.valid){setWalletValidation(response.data);}else{}}catch(error){}finally{setValidatingWallet(false);}};const validateAmount=()=>{const crypto=parseFloat(cryptoAmount);if(!crypto||crypto<=0){toast.error('Please enter a valid amount');return false;}if(crypto<offer.min_purchase){toast.error(\"Minimum order is \".concat(offer.min_purchase,\" \").concat(offer.crypto_currency));return false;}if(crypto>offer.max_purchase){toast.error(\"Maximum order is \".concat(offer.max_purchase,\" \").concat(offer.crypto_currency));return false;}return true;};const handleConfirmOrder=async()=>{if(!validateAmount())return;// NEW: Optional wallet validation (non-blocking)\ntry{await validateWalletAddress();}catch(err){}setProcessing(true);try{const tradePayload={sell_order_id:offer.order_id,buyer_id:currentUser.user_id,crypto_amount:parseFloat(cryptoAmount),payment_method:offer.payment_methods[0],buyer_wallet_address:walletAddress,buyer_wallet_network:walletNetwork||null};const response=await axios.post(\"\".concat(API,\"/api/p2p/create-trade\"),tradePayload);if(response.data.success){var _response$data$trade;const tradeId=response.data.trade_id||((_response$data$trade=response.data.trade)===null||_response$data$trade===void 0?void 0:_response$data$trade.trade_id)||response.data.id;if(!tradeId){console.error('❌ No trade_id in response!',response.data);toast.error('Trade created but ID missing');return;}toast.success('Trade created! Crypto locked in escrow.');setTimeout(()=>{navigate(\"/p2p/trade/\".concat(tradeId));},1500);}}catch(error){var _error$response,_error$response$data;console.error('Error creating trade:',error);toast.error(((_error$response=error.response)===null||_error$response===void 0?void 0:(_error$response$data=_error$response.data)===null||_error$response$data===void 0?void 0:_error$response$data.detail)||'Failed to create trade');}finally{setProcessing(false);}};if(!offer){return/*#__PURE__*/_jsx(Layout,{children:/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',justifyContent:'center',alignItems:'center',minHeight:'60vh',flexDirection:'column',gap:'1rem'},children:[/*#__PURE__*/_jsx(\"p\",{style:{color:'#888',fontSize:'18px'},children:\"No offer selected\"}),/*#__PURE__*/_jsx(Button,{onClick:()=>navigate('/p2p-marketplace'),children:\"Back to Marketplace\"})]})});}const currency=offer.fiat_currency||'GBP';const symbol=getCurrencySymbol(currency);const minFiat=(offer.min_purchase*offer.price_per_unit).toFixed(2);const maxFiat=(offer.max_purchase*offer.price_per_unit).toFixed(2);const cryptoCurrency=offer.crypto_currency||'BTC';return/*#__PURE__*/_jsx(Layout,{children:/*#__PURE__*/_jsxs(\"div\",{style:{maxWidth:'800px',margin:'0 auto',padding:'1.5rem 1rem'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'1.5rem'},children:[/*#__PURE__*/_jsx(\"h1\",{style:{fontSize:'1.75rem',fontWeight:'900',color:'#00F0FF',marginBottom:'0.5rem'},children:\"Order Preview\"}),/*#__PURE__*/_jsx(\"p\",{style:{color:'#888',fontSize:'0.875rem'},children:\"Review details before confirming your purchase\"})]}),/*#__PURE__*/_jsx(\"div\",{style:{background:'rgba(26, 31, 58, 0.9)',border:'2px solid rgba(0, 240, 255, 0.3)',borderRadius:'16px',padding:'1.25rem',marginBottom:'1.5rem',boxShadow:'0 4px 20px rgba(0, 0, 0, 0.3)'},children:/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',alignItems:'center',gap:'1rem',marginBottom:'1rem'},children:[/*#__PURE__*/_jsx(\"div\",{style:{width:'56px',height:'56px',borderRadius:'50%',background:'linear-gradient(135deg, #00F0FF, #A855F7)',display:'flex',alignItems:'center',justifyContent:'center',fontSize:'1.25rem',fontWeight:'700',color:'#000',flexShrink:0},children:((_offer$seller_name=offer.seller_name)===null||_offer$seller_name===void 0?void 0:_offer$seller_name.substring(0,2).toUpperCase())||'SE'}),/*#__PURE__*/_jsxs(\"div\",{style:{flex:1,minWidth:0},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',alignItems:'center',gap:'0.5rem',marginBottom:'0.25rem',flexWrap:'wrap'},children:[/*#__PURE__*/_jsx(\"span\",{style:{fontSize:'1.125rem',fontWeight:'700',color:'#fff'},children:offer.seller_name||'Seller****'}),/*#__PURE__*/_jsx(CheckCircle2,{size:18,style:{color:'#10B981',flexShrink:0}})]}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',alignItems:'center',gap:'1rem',fontSize:'0.8125rem',flexWrap:'wrap'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',alignItems:'center',gap:'0.25rem'},children:[/*#__PURE__*/_jsx(IoStar,{size:14,fill:\"#FFD700\",stroke:\"#FFD700\"}),/*#__PURE__*/_jsx(\"span\",{style:{color:'#fff',fontWeight:'600'},children:\"4.8\"})]}),/*#__PURE__*/_jsx(\"span\",{style:{color:'#888'},children:\"156 trades\"}),/*#__PURE__*/_jsx(\"span\",{style:{color:'#10B981',fontWeight:'600'},children:\"98.5% completion\"})]})]})]})}),/*#__PURE__*/_jsxs(\"div\",{style:{background:'rgba(26, 31, 58, 0.9)',border:'2px solid rgba(0, 240, 255, 0.3)',borderRadius:'16px',padding:'1.25rem',marginBottom:'1.5rem'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'1.25rem'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{color:'#888',fontSize:'0.8125rem',marginBottom:'0.5rem',textTransform:'uppercase',letterSpacing:'0.05em'},children:[\"Price per \",cryptoCurrency]}),/*#__PURE__*/_jsxs(\"div\",{style:{color:'#00F0FF',fontSize:'1.75rem',fontWeight:'900'},children:[symbol,(_offer$price_per_unit=offer.price_per_unit)===null||_offer$price_per_unit===void 0?void 0:_offer$price_per_unit.toLocaleString()]})]}),/*#__PURE__*/_jsxs(\"div\",{style:{paddingTop:'1rem',borderTop:'1px solid rgba(0, 240, 255, 0.15)'},children:[/*#__PURE__*/_jsx(\"div\",{style:{color:'#888',fontSize:'0.8125rem',marginBottom:'0.75rem',textTransform:'uppercase',letterSpacing:'0.05em'},children:\"Order Limits\"}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'1rem'},children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"div\",{style:{color:'#666',fontSize:'0.75rem',marginBottom:'0.25rem'},children:\"Minimum\"}),/*#__PURE__*/_jsxs(\"div\",{style:{color:'#fff',fontSize:'0.9375rem',fontWeight:'700'},children:[symbol,minFiat]}),/*#__PURE__*/_jsxs(\"div\",{style:{color:'#888',fontSize:'0.75rem'},children:[offer.min_purchase,\" \",cryptoCurrency]})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"div\",{style:{color:'#666',fontSize:'0.75rem',marginBottom:'0.25rem'},children:\"Maximum\"}),/*#__PURE__*/_jsxs(\"div\",{style:{color:'#fff',fontSize:'0.9375rem',fontWeight:'700'},children:[symbol,maxFiat]}),/*#__PURE__*/_jsxs(\"div\",{style:{color:'#888',fontSize:'0.75rem'},children:[offer.max_purchase,\" \",cryptoCurrency]})]})]})]})]}),/*#__PURE__*/_jsxs(\"div\",{style:{background:'rgba(26, 31, 58, 0.9)',border:'2px solid rgba(0, 240, 255, 0.3)',borderRadius:'16px',padding:'1.25rem',marginBottom:'1.5rem'},children:[/*#__PURE__*/_jsx(\"div\",{style:{color:'#888',fontSize:'0.8125rem',textTransform:'uppercase',letterSpacing:'0.05em',marginBottom:'1rem'},children:\"Enter Amount\"}),/*#__PURE__*/_jsx(DualCurrencyInput,{cryptoSymbol:cryptoCurrency,fiatCurrency:currency,onFiatChange:amount=>setFiatAmount(amount.toString()),onCryptoChange:amount=>setCryptoAmount(amount.toString()),initialFiatAmount:fiatAmount,initialCryptoAmount:cryptoAmount,fee:0,showCurrencySelector:false,label:\"\"})]}),/*#__PURE__*/_jsxs(\"div\",{style:{background:'rgba(26, 31, 58, 0.9)',border:'2px solid rgba(0, 240, 255, 0.3)',borderRadius:'16px',padding:'1.25rem',marginBottom:'1.5rem'},children:[/*#__PURE__*/_jsx(\"div\",{style:{color:'#888',fontSize:'0.8125rem',marginBottom:'0.75rem',textTransform:'uppercase',letterSpacing:'0.05em'},children:\"Payment Methods Available\"}),/*#__PURE__*/_jsx(\"div\",{style:{display:'flex',gap:'0.5rem',flexWrap:'wrap'},children:(_offer$payment_method=offer.payment_methods)===null||_offer$payment_method===void 0?void 0:_offer$payment_method.slice(0,3).map((method,idx)=>/*#__PURE__*/_jsxs(\"div\",{style:{background:'rgba(0, 240, 255, 0.1)',border:'1px solid rgba(0, 240, 255, 0.3)',borderRadius:'8px',padding:'0.5rem 1rem',color:'#00F0FF',fontSize:'0.8125rem',fontWeight:'600',display:'flex',alignItems:'center',gap:'0.5rem'},children:[/*#__PURE__*/_jsx(IoCard,{size:16}),method.replace(/_/g,' ').toUpperCase()]},idx))})]}),/*#__PURE__*/_jsxs(\"div\",{style:{background:'rgba(26, 31, 58, 0.9)',border:'2px solid rgba(168, 85, 247, 0.4)',borderRadius:'16px',padding:'1.25rem',marginBottom:'1.5rem'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{color:'#888',fontSize:'0.8125rem',marginBottom:'0.75rem',textTransform:'uppercase',letterSpacing:'0.05em'},children:[\"Your \",cryptoCurrency,\" Wallet Address\"]}),/*#__PURE__*/_jsx(\"div\",{style:{marginBottom:'0.75rem'},children:/*#__PURE__*/_jsx(\"input\",{type:\"text\",value:walletAddress,onChange:e=>setWalletAddress(e.target.value),placeholder:\"Enter your \".concat(cryptoCurrency,\" wallet address\"),style:{width:'100%',fontSize:'1rem',fontWeight:'600',color:'#fff',background:'rgba(0, 0, 0, 0.4)',border:walletValidation!==null&&walletValidation!==void 0&&walletValidation.valid?'2px solid #22C55E':'2px solid rgba(168, 85, 247, 0.3)',borderRadius:'10px',padding:'1rem',fontFamily:'monospace'}})}),/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'0.75rem'},children:[/*#__PURE__*/_jsx(\"label\",{style:{color:'#888',fontSize:'0.8125rem',display:'block',marginBottom:'0.5rem'},children:\"Network (Optional)\"}),/*#__PURE__*/_jsxs(\"select\",{value:walletNetwork,onChange:e=>setWalletNetwork(e.target.value),style:{width:'100%',fontSize:'0.875rem',fontWeight:'600',color:'#fff',background:'rgba(0, 0, 0, 0.4)',border:'2px solid rgba(168, 85, 247, 0.3)',borderRadius:'8px',padding:'0.75rem'},children:[/*#__PURE__*/_jsx(\"option\",{value:\"\",children:\"Select Network\"}),/*#__PURE__*/_jsx(\"option\",{value:\"mainnet\",children:\"Mainnet\"}),/*#__PURE__*/_jsx(\"option\",{value:\"legacy\",children:\"Legacy\"}),/*#__PURE__*/_jsx(\"option\",{value:\"segwit\",children:\"SegWit\"})]})]}),validatingWallet&&/*#__PURE__*/_jsx(\"div\",{style:{color:'#F59E0B',fontSize:'0.875rem',marginBottom:'0.5rem'},children:\"\\uD83D\\uDD04 Validating wallet address...\"}),(walletValidation===null||walletValidation===void 0?void 0:walletValidation.valid)&&/*#__PURE__*/_jsxs(\"div\",{style:{color:'#22C55E',fontSize:'0.875rem',marginBottom:'0.5rem',display:'flex',alignItems:'center',gap:'0.5rem'},children:[\"\\u2713 Valid \",cryptoCurrency,\" \",walletValidation.address_type||'Legacy',\" address\"]}),walletValidation&&!walletValidation.valid&&/*#__PURE__*/_jsx(\"div\",{style:{color:'#EF4444',fontSize:'0.875rem',marginBottom:'0.5rem'},children:\"\\u274C Invalid wallet address format\"}),/*#__PURE__*/_jsxs(\"div\",{style:{color:'#888',fontSize:'0.75rem',lineHeight:'1.5'},children:[\"\\uD83D\\uDCA1 Enter the wallet address where you want to receive your \",cryptoCurrency,\". Double-check for accuracy.\"]})]}),/*#__PURE__*/_jsx(\"button\",{onClick:handleConfirmOrder,disabled:processing||!cryptoAmount||parseFloat(cryptoAmount)<=0||!walletAddress.trim(),style:{width:'100%',minHeight:'60px',background:processing||!cryptoAmount||parseFloat(cryptoAmount)<=0||!walletAddress.trim()?'rgba(100,100,100,0.5)':'linear-gradient(135deg, #22C55E, #16A34A)',border:'none',borderRadius:'16px',fontSize:'1.125rem',fontWeight:'900',color:'#fff',cursor:processing||!cryptoAmount||parseFloat(cryptoAmount)<=0||!walletAddress.trim()?'not-allowed':'pointer',boxShadow:processing||!cryptoAmount||parseFloat(cryptoAmount)<=0||!walletAddress.trim()?'none':'0 4px 24px rgba(34, 197, 94, 0.5), 0 0 40px rgba(34, 197, 94, 0.3)',display:'flex',alignItems:'center',justifyContent:'center',gap:'0.75rem',textTransform:'uppercase',letterSpacing:'0.05em',opacity:processing||!cryptoAmount||parseFloat(cryptoAmount)<=0||!walletAddress.trim()?0.5:1,transition:'all 0.3s'},onMouseEnter:e=>{if(!processing&&cryptoAmount&&parseFloat(cryptoAmount)>0){e.currentTarget.style.transform='translateY(-2px)';e.currentTarget.style.boxShadow='0 8px 40px rgba(34, 197, 94, 0.7), 0 0 60px rgba(34, 197, 94, 0.5)';}},onMouseLeave:e=>{if(!processing&&cryptoAmount&&parseFloat(cryptoAmount)>0){e.currentTarget.style.transform='translateY(0)';e.currentTarget.style.boxShadow='0 4px 24px rgba(34, 197, 94, 0.5), 0 0 40px rgba(34, 197, 94, 0.3)';}},children:processing?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(\"div\",{className:\"spinner\",style:{width:'20px',height:'20px',borderWidth:'2px'}}),\"Processing...\"]}):/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(IoShield,{size:24}),\"Confirm & Lock in Escrow\"]})})]})});}","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}