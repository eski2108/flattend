{"ast":null,"code":"import React,{createContext,useContext,useState,useEffect}from'react';import{ethers}from'ethers';import axios from'axios';import{toast}from'sonner';import{jsx as _jsx}from\"react/jsx-runtime\";const WalletContext=/*#__PURE__*/createContext();const BACKEND_URL=process.env.REACT_APP_BACKEND_URL;const API=\"\".concat(BACKEND_URL,\"/api\");export const useWallet=()=>{const context=useContext(WalletContext);if(!context){throw new Error('useWallet must be used within WalletProvider');}return context;};export const WalletProvider=_ref=>{let{children}=_ref;const[account,setAccount]=useState(null);const[provider,setProvider]=useState(null);const[isConnecting,setIsConnecting]=useState(false);const[user,setUser]=useState(null);useEffect(()=>{// Check if already connected\ncheckConnection();},[]);const checkConnection=async()=>{// First check localStorage for email/password login\nconst storedUser=localStorage.getItem('cryptobank_user');const storedToken=localStorage.getItem('token');if(storedUser&&storedToken){try{const userData=JSON.parse(storedUser);// SET USER IMMEDIATELY from localStorage - don't wait for API\nsetUser(userData);// Then fetch fresh user data from backend in background\ntry{const response=await axios.get(\"\".concat(API,\"/user/profile/\").concat(userData.user_id),{headers:{'Authorization':\"Bearer \".concat(storedToken)}});if(response.data.success){const freshUserData=response.data.user;setUser(freshUserData);// Update localStorage with fresh data\nlocalStorage.setItem('cryptobank_user',JSON.stringify(freshUserData));return;}}catch(apiError){console.error('Error fetching fresh user data:',apiError);// If API call fails but we have stored data, use it\nsetUser(userData);return;}}catch(error){console.error('Error parsing stored user:',error);localStorage.removeItem('cryptobank_user');localStorage.removeItem('token');}}// Then check MetaMask wallet connection\nif(typeof window.ethereum!=='undefined'){try{const provider=new ethers.BrowserProvider(window.ethereum);const accounts=await provider.listAccounts();if(accounts.length>0){const account=accounts[0].address;setAccount(account);setProvider(provider);await fetchUserProfile(account);}}catch(error){console.error('Error checking MetaMask connection:',error);}}};const connectWallet=async()=>{if(typeof window.ethereum==='undefined'){toast.error('Please install MetaMask to use this platform');return;}setIsConnecting(true);try{const provider=new ethers.BrowserProvider(window.ethereum);await provider.send('eth_requestAccounts',[]);const signer=await provider.getSigner();const address=await signer.getAddress();setProvider(provider);setAccount(address);// Register/login with backend\nconst response=await axios.post(\"\".concat(API,\"/auth/connect-wallet\"),{wallet_address:address});if(response.data.success){setUser(response.data.user);toast.success('Wallet connected successfully!');}}catch(error){console.error('Error connecting wallet:',error);toast.error('Failed to connect wallet');}finally{setIsConnecting(false);}};const disconnectWallet=()=>{setAccount(null);setProvider(null);setUser(null);// Clear all localStorage data\nlocalStorage.clear();sessionStorage.clear();toast.info('Logged out successfully');};const fetchUserProfile=async walletAddress=>{try{const response=await axios.get(\"\".concat(API,\"/user/profile/\").concat(walletAddress));if(response.data.success){setUser(response.data.user);}}catch(error){console.error('Error fetching user profile:',error);}};const refreshUser=async()=>{if(account){await fetchUserProfile(account);}};return/*#__PURE__*/_jsx(WalletContext.Provider,{value:{account,provider,user,isConnecting,connectWallet,disconnectWallet,refreshUser},children:children});};","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}