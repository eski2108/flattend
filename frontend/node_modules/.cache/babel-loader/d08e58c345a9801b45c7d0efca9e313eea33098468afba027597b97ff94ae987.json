{"ast":null,"code":"import React,{useEffect,useState}from'react';import{useNavigate}from'react-router-dom';import{useWallet}from'@/contexts/WalletContext';import Layout from'@/components/Layout';import{Card}from'@/components/ui/card';import{Button}from'@/components/ui/button';import{Input}from'@/components/ui/input';import{Dialog,DialogContent,DialogHeader,DialogTitle,DialogDescription}from'@/components/ui/dialog';import{Copy,DollarSign,IoAlertCircle,IoCash,IoCheckmark as Check,IoCheckmarkCircle,IoCopy,IoSearch,IoTime,Search}from'react-icons/io5';import axios from'axios';import{toast}from'sonner';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const BACKEND_URL=process.env.REACT_APP_BACKEND_URL;const API=BACKEND_URL;export default function BuyCrypto(){const{account,refreshUser}=useWallet();const navigate=useNavigate();const[sellOrders,setSellOrders]=useState([]);const[loading,setLoading]=useState(true);const[searchTerm,setSearchTerm]=useState('');const[selectedOrder,setSelectedOrder]=useState(null);const[buyAmount,setBuyAmount]=useState('');const[processing,setProcessing]=useState(false);const[buyOrderDetails,setBuyOrderDetails]=useState(null);const[showPaymentDialog,setShowPaymentDialog]=useState(false);const[paymentReference,setPaymentReference]=useState('');useEffect(()=>{if(!account){navigate('/');return;}fetchSellOrders();},[account,navigate]);const fetchSellOrders=async()=>{try{const response=await axios.get(\"\".concat(API,\"/api/crypto-market/sell/orders\"));if(response.data.success){setSellOrders(response.data.orders);}}catch(error){console.error('Error fetching sell orders:',error);toast.error('Failed to load sell orders');}finally{setLoading(false);}};const handleBuy=async()=>{if(!selectedOrder||!buyAmount){toast.error('Please enter amount');return;}const amount=parseFloat(buyAmount);if(amount<selectedOrder.min_purchase||amount>selectedOrder.max_purchase){toast.error(\"Amount must be between \".concat(selectedOrder.min_purchase,\" and \").concat(selectedOrder.max_purchase,\" ETH\"));return;}setProcessing(true);try{const response=await axios.post(\"\".concat(API,\"/api/crypto-market/buy/create\"),{buyer_address:account,sell_order_id:selectedOrder.order_id,crypto_amount:amount});if(response.data.success){toast.success('Buy order created! Please complete bank transfer');setBuyOrderDetails(response.data);setSelectedOrder(null);setBuyAmount('');setShowPaymentDialog(true);fetchSellOrders();}}catch(error){var _error$response,_error$response$data;console.error('Error creating buy order:',error);toast.error(((_error$response=error.response)===null||_error$response===void 0?void 0:(_error$response$data=_error$response.data)===null||_error$response$data===void 0?void 0:_error$response$data.detail)||'Failed to create buy order');}finally{setProcessing(false);}};const handleMarkAsPaid=async()=>{if(!paymentReference){toast.error('Please enter payment reference');return;}try{const response=await axios.post(\"\".concat(API,\"/api/crypto-market/payment/mark-paid\"),{buyer_address:account,order_id:buyOrderDetails.order.order_id,payment_reference:paymentReference});if(response.data.success){toast.success('âœ“ Marked as Paid! Seller will be notified to release crypto');setShowPaymentDialog(false);setBuyOrderDetails(null);setPaymentReference('');await refreshUser();}}catch(error){var _error$response2,_error$response2$data;console.error('Error marking as paid:',error);toast.error(((_error$response2=error.response)===null||_error$response2===void 0?void 0:(_error$response2$data=_error$response2.data)===null||_error$response2$data===void 0?void 0:_error$response2$data.detail)||'Failed to mark as paid');}};const copyToClipboard=text=>{navigator.clipboard.writeText(text);toast.success('Copied to clipboard');};const filteredOrders=sellOrders.filter(order=>order.crypto_amount.toString().includes(searchTerm)||order.seller_address.toLowerCase().includes(searchTerm.toLowerCase()));return/*#__PURE__*/_jsxs(Layout,{children:[/*#__PURE__*/_jsxs(\"div\",{className:\"buy-crypto-page\",\"data-testid\":\"buy-crypto-page\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"page-header\",children:/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h1\",{className:\"page-title\",\"data-testid\":\"buy-crypto-title\",children:\"Buy Crypto with Bank Transfer\"}),/*#__PURE__*/_jsx(\"p\",{className:\"page-subtitle\",children:\"Purchase crypto directly from lenders using bank transfer\"})]})}),/*#__PURE__*/_jsx(\"div\",{className:\"search-container\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"search-input-wrapper\",children:[/*#__PURE__*/_jsx(IoSearch,{className:\"search-icon\",size:20}),/*#__PURE__*/_jsx(Input,{placeholder:\"Search by amount or seller address...\",value:searchTerm,onChange:e=>setSearchTerm(e.target.value),className:\"search-input\",\"data-testid\":\"search-input\"})]})}),loading?/*#__PURE__*/_jsx(\"div\",{className:\"loading-container\",\"data-testid\":\"loading-spinner\",children:/*#__PURE__*/_jsx(\"div\",{className:\"spinner\"})}):filteredOrders.length>0?/*#__PURE__*/_jsx(\"div\",{className:\"offers-grid\",children:filteredOrders.map(order=>{const totalValue=order.crypto_amount*order.price_per_unit;return/*#__PURE__*/_jsxs(Card,{className:\"sell-order-card\",\"data-testid\":\"sell-order-card\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"order-header\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"order-badge\",children:\"Available\"}),/*#__PURE__*/_jsx(IoCash,{size:20,className:\"order-icon\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"order-amount\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"amount-value\",children:order.crypto_amount||0}),/*#__PURE__*/_jsx(\"span\",{className:\"amount-currency\",children:\"ETH\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"order-price\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"price-label\",children:\"Price:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"price-value\",children:[\"$\",(order.price_per_unit||0).toLocaleString(),\" / ETH\"]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"order-details\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"detail-row\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"detail-label\",children:\"Total Value:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"detail-value\",children:[\"$\",isNaN(totalValue)?'0':totalValue.toLocaleString()]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"detail-row\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"detail-label\",children:\"Min Purchase:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"detail-value\",children:[order.min_purchase||0,\" ETH\"]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"detail-row\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"detail-label\",children:\"Max Purchase:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"detail-value\",children:[order.max_purchase||0,\" ETH\"]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"detail-row\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"detail-label\",children:\"Seller:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"detail-value address\",children:[order.seller_address.slice(0,6),\"...\",order.seller_address.slice(-4)]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"detail-row\",children:[/*#__PURE__*/_jsx(\"span\",{className:\"detail-label\",children:\"Payment:\"}),/*#__PURE__*/_jsx(\"span\",{className:\"detail-value\",children:\"Bank Transfer\"})]})]}),/*#__PURE__*/_jsx(Button,{className:\"buy-btn\",onClick:()=>setSelectedOrder(order),disabled:order.seller_address===account,\"data-testid\":\"buy-now-btn\",children:order.seller_address===account?'Your Order':'Buy Now'})]},order.order_id);})}):/*#__PURE__*/_jsxs(Card,{className:\"empty-state\",\"data-testid\":\"empty-orders\",children:[/*#__PURE__*/_jsx(IoAlertCircle,{size:48,className:\"empty-icon\"}),/*#__PURE__*/_jsx(\"h3\",{children:\"No Sell Orders Available\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Check back later or create your own sell order\"}),/*#__PURE__*/_jsx(Button,{onClick:()=>navigate('/sell-crypto'),\"data-testid\":\"create-sell-order-btn\",children:\"Create Sell Order\"})]})]}),/*#__PURE__*/_jsx(Dialog,{open:!!selectedOrder,onOpenChange:()=>setSelectedOrder(null),children:/*#__PURE__*/_jsxs(DialogContent,{className:\"buy-dialog\",\"data-testid\":\"buy-dialog\",children:[/*#__PURE__*/_jsxs(DialogHeader,{children:[/*#__PURE__*/_jsx(DialogTitle,{children:\"Buy Crypto\"}),/*#__PURE__*/_jsx(DialogDescription,{children:\"Enter amount to purchase\"})]}),selectedOrder&&/*#__PURE__*/_jsxs(\"div\",{className:\"dialog-content\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"order-info\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"info-row\",children:[/*#__PURE__*/_jsx(\"span\",{children:\"Available:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"info-value\",children:[selectedOrder.crypto_amount||0,\" ETH\"]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"info-row\",children:[/*#__PURE__*/_jsx(\"span\",{children:\"Price per ETH:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"info-value\",children:[\"$\",(selectedOrder.price_per_unit||0).toLocaleString()]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"info-row\",children:[/*#__PURE__*/_jsx(\"span\",{children:\"Min - Max:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"info-value\",children:[selectedOrder.min_purchase||0,\" - \",selectedOrder.max_purchase||0,\" ETH\"]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"input-group\",children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"buy-amount\",children:\"Amount (ETH)\"}),/*#__PURE__*/_jsx(Input,{id:\"buy-amount\",type:\"number\",placeholder:\"Enter amount\",value:buyAmount,onChange:e=>setBuyAmount(e.target.value),\"data-testid\":\"buy-amount-input\"})]}),buyAmount&&/*#__PURE__*/_jsxs(\"div\",{className:\"calculation\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"calc-row\",children:[/*#__PURE__*/_jsx(\"span\",{children:\"Crypto Amount:\"}),/*#__PURE__*/_jsxs(\"span\",{children:[parseFloat(buyAmount).toFixed(4),\" ETH\"]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"calc-row total\",children:[/*#__PURE__*/_jsx(\"span\",{children:\"Total to Pay:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"highlight\",children:[\"$\",(parseFloat(buyAmount)*selectedOrder.price_per_unit).toLocaleString()]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"info-box\",children:[/*#__PURE__*/_jsx(IoTime,{size:20}),/*#__PURE__*/_jsx(\"p\",{children:\"You'll have 30 minutes to complete the bank transfer\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"dialog-actions\",children:[/*#__PURE__*/_jsx(Button,{variant:\"outline\",onClick:()=>setSelectedOrder(null),\"data-testid\":\"cancel-btn\",children:\"Cancel\"}),/*#__PURE__*/_jsx(Button,{onClick:handleBuy,disabled:processing,\"data-testid\":\"confirm-buy-btn\",children:processing?'Processing...':'Proceed to Payment'})]})]})]})}),/*#__PURE__*/_jsx(Dialog,{open:showPaymentDialog,onOpenChange:setShowPaymentDialog,children:/*#__PURE__*/_jsxs(DialogContent,{className:\"payment-dialog\",\"data-testid\":\"payment-dialog\",children:[/*#__PURE__*/_jsxs(DialogHeader,{children:[/*#__PURE__*/_jsx(DialogTitle,{children:\"Complete Bank Transfer\"}),/*#__PURE__*/_jsx(DialogDescription,{children:\"Transfer funds to seller's bank account\"})]}),buyOrderDetails&&/*#__PURE__*/_jsxs(\"div\",{className:\"dialog-content\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"payment-timer\",children:[/*#__PURE__*/_jsx(IoTime,{size:24}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"p\",{className:\"timer-label\",children:\"Payment Deadline\"}),/*#__PURE__*/_jsx(\"p\",{className:\"timer-value\",children:new Date(buyOrderDetails.payment_deadline).toLocaleString()})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"bank-details-card\",children:[/*#__PURE__*/_jsx(\"h3\",{children:\"Seller's Bank Details\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"bank-detail-row\",children:[/*#__PURE__*/_jsx(\"span\",{children:\"Bank Name:\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"copy-field\",children:[/*#__PURE__*/_jsx(\"span\",{children:buyOrderDetails.seller_bank_details.bank_name}),/*#__PURE__*/_jsx(Button,{size:\"sm\",variant:\"ghost\",onClick:()=>copyToClipboard(buyOrderDetails.seller_bank_details.bank_name),\"data-testid\":\"copy-bank-name\",children:/*#__PURE__*/_jsx(IoCopy,{size:16})})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"bank-detail-row\",children:[/*#__PURE__*/_jsx(\"span\",{children:\"Account Holder:\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"copy-field\",children:[/*#__PURE__*/_jsx(\"span\",{children:buyOrderDetails.seller_bank_details.account_holder}),/*#__PURE__*/_jsx(Button,{size:\"sm\",variant:\"ghost\",onClick:()=>copyToClipboard(buyOrderDetails.seller_bank_details.account_holder),\"data-testid\":\"copy-account-holder\",children:/*#__PURE__*/_jsx(IoCopy,{size:16})})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"bank-detail-row\",children:[/*#__PURE__*/_jsx(\"span\",{children:\"Account Number:\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"copy-field\",children:[/*#__PURE__*/_jsx(\"span\",{children:buyOrderDetails.seller_bank_details.account_number}),/*#__PURE__*/_jsx(Button,{size:\"sm\",variant:\"ghost\",onClick:()=>copyToClipboard(buyOrderDetails.seller_bank_details.account_number),\"data-testid\":\"copy-account-number\",children:/*#__PURE__*/_jsx(IoCopy,{size:16})})]})]}),buyOrderDetails.seller_bank_details.routing_number&&/*#__PURE__*/_jsxs(\"div\",{className:\"bank-detail-row\",children:[/*#__PURE__*/_jsx(\"span\",{children:\"Routing Number:\"}),/*#__PURE__*/_jsxs(\"div\",{className:\"copy-field\",children:[/*#__PURE__*/_jsx(\"span\",{children:buyOrderDetails.seller_bank_details.routing_number}),/*#__PURE__*/_jsx(Button,{size:\"sm\",variant:\"ghost\",onClick:()=>copyToClipboard(buyOrderDetails.seller_bank_details.routing_number),\"data-testid\":\"copy-routing-number\",children:/*#__PURE__*/_jsx(IoCopy,{size:16})})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"bank-detail-row highlight\",children:[/*#__PURE__*/_jsx(\"span\",{children:\"Amount to Transfer:\"}),/*#__PURE__*/_jsxs(\"span\",{className:\"amount-highlight\",children:[\"$\",buyOrderDetails.order.total_price.toLocaleString()]})]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"input-group\",children:[/*#__PURE__*/_jsx(\"label\",{htmlFor:\"payment-ref\",children:\"Payment Reference / Transaction ID\"}),/*#__PURE__*/_jsx(Input,{id:\"payment-ref\",placeholder:\"Enter your bank transfer reference\",value:paymentReference,onChange:e=>setPaymentReference(e.target.value),\"data-testid\":\"payment-reference-input\"}),/*#__PURE__*/_jsx(\"p\",{className:\"input-hint\",children:\"Enter the transaction ID from your bank transfer\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"info-box warn\",children:[/*#__PURE__*/_jsx(IoAlertCircle,{size:20}),/*#__PURE__*/_jsx(\"p\",{children:\"After making the transfer, confirm payment below. Seller will release crypto once verified.\"})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"dialog-actions\",children:[/*#__PURE__*/_jsx(Button,{variant:\"outline\",onClick:()=>{setShowPaymentDialog(false);setBuyOrderDetails(null);},\"data-testid\":\"cancel-payment-btn\",children:\"Cancel\"}),/*#__PURE__*/_jsxs(Button,{onClick:handleMarkAsPaid,\"data-testid\":\"mark-paid-btn\",className:\"mark-paid-btn\",children:[/*#__PURE__*/_jsx(IoCheckmarkCircle,{size:20,className:\"mr-2\"}),\"Mark as Paid\"]})]})]})]})})]});}","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}