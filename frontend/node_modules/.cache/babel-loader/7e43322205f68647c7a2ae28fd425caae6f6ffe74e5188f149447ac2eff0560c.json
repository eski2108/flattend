{"ast":null,"code":"import { equalSizes, size } from \"./size.mjs\";\nimport { createObservable as createDevicePixelRatioObservable } from \"./device-pixel-ratio.mjs\";\nvar DevicePixelContentBoxBinding = /** @class */function () {\n  function DevicePixelContentBoxBinding(canvasElement, transformBitmapSize, options) {\n    var _a;\n    this._canvasElement = null;\n    this._bitmapSizeChangedListeners = [];\n    this._suggestedBitmapSize = null;\n    this._suggestedBitmapSizeChangedListeners = [];\n    // devicePixelRatio approach\n    this._devicePixelRatioObservable = null;\n    // ResizeObserver approach\n    this._canvasElementResizeObserver = null;\n    this._canvasElement = canvasElement;\n    this._canvasElementClientSize = size({\n      width: this._canvasElement.clientWidth,\n      height: this._canvasElement.clientHeight\n    });\n    this._transformBitmapSize = transformBitmapSize !== null && transformBitmapSize !== void 0 ? transformBitmapSize : function (size) {\n      return size;\n    };\n    this._allowResizeObserver = (_a = options === null || options === void 0 ? void 0 : options.allowResizeObserver) !== null && _a !== void 0 ? _a : true;\n    this._chooseAndInitObserver();\n    // we MAY leave the constuctor without any bitmap size observation mechanics initialized\n  }\n  DevicePixelContentBoxBinding.prototype.dispose = function () {\n    var _a, _b;\n    if (this._canvasElement === null) {\n      throw new Error('Object is disposed');\n    }\n    (_a = this._canvasElementResizeObserver) === null || _a === void 0 ? void 0 : _a.disconnect();\n    this._canvasElementResizeObserver = null;\n    (_b = this._devicePixelRatioObservable) === null || _b === void 0 ? void 0 : _b.dispose();\n    this._devicePixelRatioObservable = null;\n    this._suggestedBitmapSizeChangedListeners.length = 0;\n    this._bitmapSizeChangedListeners.length = 0;\n    this._canvasElement = null;\n  };\n  Object.defineProperty(DevicePixelContentBoxBinding.prototype, \"canvasElement\", {\n    get: function () {\n      if (this._canvasElement === null) {\n        throw new Error('Object is disposed');\n      }\n      return this._canvasElement;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(DevicePixelContentBoxBinding.prototype, \"canvasElementClientSize\", {\n    get: function () {\n      return this._canvasElementClientSize;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(DevicePixelContentBoxBinding.prototype, \"bitmapSize\", {\n    get: function () {\n      return size({\n        width: this.canvasElement.width,\n        height: this.canvasElement.height\n      });\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\n   * Use this function to change canvas element client size until binding is disposed\n   * @param clientSize New client size for bound HTMLCanvasElement\n   */\n  DevicePixelContentBoxBinding.prototype.resizeCanvasElement = function (clientSize) {\n    this._canvasElementClientSize = size(clientSize);\n    this.canvasElement.style.width = \"\".concat(this._canvasElementClientSize.width, \"px\");\n    this.canvasElement.style.height = \"\".concat(this._canvasElementClientSize.height, \"px\");\n    this._invalidateBitmapSize();\n  };\n  DevicePixelContentBoxBinding.prototype.subscribeBitmapSizeChanged = function (listener) {\n    this._bitmapSizeChangedListeners.push(listener);\n  };\n  DevicePixelContentBoxBinding.prototype.unsubscribeBitmapSizeChanged = function (listener) {\n    this._bitmapSizeChangedListeners = this._bitmapSizeChangedListeners.filter(function (l) {\n      return l !== listener;\n    });\n  };\n  Object.defineProperty(DevicePixelContentBoxBinding.prototype, \"suggestedBitmapSize\", {\n    get: function () {\n      return this._suggestedBitmapSize;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  DevicePixelContentBoxBinding.prototype.subscribeSuggestedBitmapSizeChanged = function (listener) {\n    this._suggestedBitmapSizeChangedListeners.push(listener);\n  };\n  DevicePixelContentBoxBinding.prototype.unsubscribeSuggestedBitmapSizeChanged = function (listener) {\n    this._suggestedBitmapSizeChangedListeners = this._suggestedBitmapSizeChangedListeners.filter(function (l) {\n      return l !== listener;\n    });\n  };\n  DevicePixelContentBoxBinding.prototype.applySuggestedBitmapSize = function () {\n    if (this._suggestedBitmapSize === null) {\n      // nothing to apply\n      return;\n    }\n    var oldSuggestedSize = this._suggestedBitmapSize;\n    this._suggestedBitmapSize = null;\n    this._resizeBitmap(oldSuggestedSize);\n    this._emitSuggestedBitmapSizeChanged(oldSuggestedSize, this._suggestedBitmapSize);\n  };\n  DevicePixelContentBoxBinding.prototype._resizeBitmap = function (newSize) {\n    var oldSize = this.bitmapSize;\n    if (equalSizes(oldSize, newSize)) {\n      return;\n    }\n    this.canvasElement.width = newSize.width;\n    this.canvasElement.height = newSize.height;\n    this._emitBitmapSizeChanged(oldSize, newSize);\n  };\n  DevicePixelContentBoxBinding.prototype._emitBitmapSizeChanged = function (oldSize, newSize) {\n    var _this = this;\n    this._bitmapSizeChangedListeners.forEach(function (listener) {\n      return listener.call(_this, oldSize, newSize);\n    });\n  };\n  DevicePixelContentBoxBinding.prototype._suggestNewBitmapSize = function (newSize) {\n    var oldSuggestedSize = this._suggestedBitmapSize;\n    var finalNewSize = size(this._transformBitmapSize(newSize, this._canvasElementClientSize));\n    var newSuggestedSize = equalSizes(this.bitmapSize, finalNewSize) ? null : finalNewSize;\n    if (oldSuggestedSize === null && newSuggestedSize === null) {\n      return;\n    }\n    if (oldSuggestedSize !== null && newSuggestedSize !== null && equalSizes(oldSuggestedSize, newSuggestedSize)) {\n      return;\n    }\n    this._suggestedBitmapSize = newSuggestedSize;\n    this._emitSuggestedBitmapSizeChanged(oldSuggestedSize, newSuggestedSize);\n  };\n  DevicePixelContentBoxBinding.prototype._emitSuggestedBitmapSizeChanged = function (oldSize, newSize) {\n    var _this = this;\n    this._suggestedBitmapSizeChangedListeners.forEach(function (listener) {\n      return listener.call(_this, oldSize, newSize);\n    });\n  };\n  DevicePixelContentBoxBinding.prototype._chooseAndInitObserver = function () {\n    var _this = this;\n    if (!this._allowResizeObserver) {\n      this._initDevicePixelRatioObservable();\n      return;\n    }\n    isDevicePixelContentBoxSupported().then(function (isSupported) {\n      return isSupported ? _this._initResizeObserver() : _this._initDevicePixelRatioObservable();\n    });\n  };\n  // devicePixelRatio approach\n  DevicePixelContentBoxBinding.prototype._initDevicePixelRatioObservable = function () {\n    var _this = this;\n    if (this._canvasElement === null) {\n      // it looks like we are already dead\n      return;\n    }\n    var win = canvasElementWindow(this._canvasElement);\n    if (win === null) {\n      throw new Error('No window is associated with the canvas');\n    }\n    this._devicePixelRatioObservable = createDevicePixelRatioObservable(win);\n    this._devicePixelRatioObservable.subscribe(function () {\n      return _this._invalidateBitmapSize();\n    });\n    this._invalidateBitmapSize();\n  };\n  DevicePixelContentBoxBinding.prototype._invalidateBitmapSize = function () {\n    var _a, _b;\n    if (this._canvasElement === null) {\n      // it looks like we are already dead\n      return;\n    }\n    var win = canvasElementWindow(this._canvasElement);\n    if (win === null) {\n      return;\n    }\n    var ratio = (_b = (_a = this._devicePixelRatioObservable) === null || _a === void 0 ? void 0 : _a.value) !== null && _b !== void 0 ? _b : win.devicePixelRatio;\n    var canvasRects = this._canvasElement.getClientRects();\n    var newSize =\n    // eslint-disable-next-line no-negated-condition\n    canvasRects[0] !== undefined ? predictedBitmapSize(canvasRects[0], ratio) : size({\n      width: this._canvasElementClientSize.width * ratio,\n      height: this._canvasElementClientSize.height * ratio\n    });\n    this._suggestNewBitmapSize(newSize);\n  };\n  // ResizeObserver approach\n  DevicePixelContentBoxBinding.prototype._initResizeObserver = function () {\n    var _this = this;\n    if (this._canvasElement === null) {\n      // it looks like we are already dead\n      return;\n    }\n    this._canvasElementResizeObserver = new ResizeObserver(function (entries) {\n      var entry = entries.find(function (entry) {\n        return entry.target === _this._canvasElement;\n      });\n      if (!entry || !entry.devicePixelContentBoxSize || !entry.devicePixelContentBoxSize[0]) {\n        return;\n      }\n      var entrySize = entry.devicePixelContentBoxSize[0];\n      var newSize = size({\n        width: entrySize.inlineSize,\n        height: entrySize.blockSize\n      });\n      _this._suggestNewBitmapSize(newSize);\n    });\n    this._canvasElementResizeObserver.observe(this._canvasElement, {\n      box: 'device-pixel-content-box'\n    });\n  };\n  return DevicePixelContentBoxBinding;\n}();\nexport function bindTo(canvasElement, target) {\n  if (target.type === 'device-pixel-content-box') {\n    return new DevicePixelContentBoxBinding(canvasElement, target.transform, target.options);\n  }\n  throw new Error('Unsupported binding target');\n}\nfunction canvasElementWindow(canvasElement) {\n  // According to DOM Level 2 Core specification, ownerDocument should never be null for HTMLCanvasElement\n  // see https://www.w3.org/TR/2000/REC-DOM-Level-2-Core-20001113/core.html#node-ownerDoc\n  // eslint-disable-next-line @typescript-eslint/no-non-null-assertion\n  return canvasElement.ownerDocument.defaultView;\n}\nfunction isDevicePixelContentBoxSupported() {\n  return new Promise(function (resolve) {\n    var ro = new ResizeObserver(function (entries) {\n      resolve(entries.every(function (entry) {\n        return 'devicePixelContentBoxSize' in entry;\n      }));\n      ro.disconnect();\n    });\n    ro.observe(document.body, {\n      box: 'device-pixel-content-box'\n    });\n  }).catch(function () {\n    return false;\n  });\n}\nfunction predictedBitmapSize(canvasRect, ratio) {\n  return size({\n    width: Math.round(canvasRect.left * ratio + canvasRect.width * ratio) - Math.round(canvasRect.left * ratio),\n    height: Math.round(canvasRect.top * ratio + canvasRect.height * ratio) - Math.round(canvasRect.top * ratio)\n  });\n}","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}