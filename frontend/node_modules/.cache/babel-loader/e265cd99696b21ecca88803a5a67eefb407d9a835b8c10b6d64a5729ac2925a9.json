{"ast":null,"code":"import _objectSpread from\"/app/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect}from'react';import axios from'axios';import{IoAlertCircle,IoChatbubbles,IoCheckmark as Check,IoCheckmarkCircle,IoPersonOutline,IoSend,IoTime as Clock}from'react-icons/io5';import{toast}from'sonner';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";const BACKEND_URL=process.env.REACT_APP_BACKEND_URL;export default function AdminSupportChat(){const[sessions,setSessions]=useState([]);const[selectedSession,setSelectedSession]=useState(null);const[messages,setMessages]=useState([]);const[replyMessage,setReplyMessage]=useState('');const[filter,setFilter]=useState('all');// 'all', 'ai', 'live_agent'\nconst[aiSettings,setAiSettings]=useState({ai_enabled:true,has_custom_api_key:false});const[showSettings,setShowSettings]=useState(false);const[customApiKey,setCustomApiKey]=useState('');const[loading,setLoading]=useState(false);useEffect(()=>{fetchSessions();fetchAiSettings();// Poll for new messages every 10 seconds\nconst interval=setInterval(fetchSessions,10000);return()=>clearInterval(interval);},[filter]);useEffect(()=>{if(selectedSession){fetchMessages(selectedSession.session_id);// Poll for new messages in selected session\nconst interval=setInterval(()=>{fetchMessages(selectedSession.session_id);},5000);return()=>clearInterval(interval);}},[selectedSession]);const fetchSessions=async()=>{try{const statusFilter=filter==='all'?'':\"?status=\".concat(filter);const response=await axios.get(\"\".concat(BACKEND_URL,\"/api/admin/chat/sessions\").concat(statusFilter));if(response.data.success){setSessions(response.data.sessions);}}catch(error){console.error('Failed to fetch sessions:',error);}};const fetchMessages=async sessionId=>{try{const response=await axios.get(\"\".concat(BACKEND_URL,\"/api/chat/history/\").concat(sessionId));if(response.data.success){setMessages(response.data.messages);}}catch(error){console.error('Failed to fetch messages:',error);}};const fetchAiSettings=async()=>{try{const response=await axios.get(\"\".concat(BACKEND_URL,\"/api/admin/chat/settings\"));if(response.data.success){setAiSettings({ai_enabled:response.data.ai_enabled,has_custom_api_key:response.data.has_custom_api_key});}}catch(error){console.error('Failed to fetch AI settings:',error);}};const toggleAiEnabled=async()=>{try{const response=await axios.post(\"\".concat(BACKEND_URL,\"/api/admin/chat/settings\"),{ai_enabled:!aiSettings.ai_enabled});if(response.data.success){setAiSettings(prev=>_objectSpread(_objectSpread({},prev),{},{ai_enabled:!prev.ai_enabled}));toast.success(\"AI Assistant \".concat(!aiSettings.ai_enabled?'enabled':'disabled'));}}catch(error){toast.error('Failed to update settings');}};const saveCustomApiKey=async()=>{try{setLoading(true);const response=await axios.post(\"\".concat(BACKEND_URL,\"/api/admin/chat/settings\"),{custom_api_key:customApiKey});if(response.data.success){setAiSettings(prev=>_objectSpread(_objectSpread({},prev),{},{has_custom_api_key:true}));toast.success('API key saved successfully');setCustomApiKey('');setShowSettings(false);}}catch(error){toast.error('Failed to save API key');}finally{setLoading(false);}};const sendReply=async()=>{if(!replyMessage.trim()||!selectedSession)return;try{const response=await axios.post(\"\".concat(BACKEND_URL,\"/api/admin/chat/send-message\"),{session_id:selectedSession.session_id,message:replyMessage,admin_id:'ADMIN'});if(response.data.success){setReplyMessage('');fetchMessages(selectedSession.session_id);toast.success('Message sent');}}catch(error){toast.error('Failed to send message');}};const resolveChat=async sessionId=>{try{const response=await axios.post(\"\".concat(BACKEND_URL,\"/api/admin/chat/resolve\"),{session_id:sessionId});if(response.data.success){toast.success('Chat marked as resolved');fetchSessions();if((selectedSession===null||selectedSession===void 0?void 0:selectedSession.session_id)===sessionId){setSelectedSession(null);}}}catch(error){toast.error('Failed to resolve chat');}};const formatTimestamp=timestamp=>{const date=new Date(timestamp);const now=new Date();const diff=now-date;if(diff<60000)return'Just now';if(diff<3600000)return\"\".concat(Math.floor(diff/60000),\"m ago\");if(diff<86400000)return\"\".concat(Math.floor(diff/3600000),\"h ago\");return date.toLocaleDateString();};return/*#__PURE__*/_jsxs(\"div\",{style:{padding:'2rem'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'2rem',display:'flex',justifyContent:'space-between',alignItems:'center'},children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h1\",{style:{fontSize:'28px',fontWeight:'900',color:'#00F0FF',marginBottom:'0.5rem'},children:\"Support Chat\"}),/*#__PURE__*/_jsx(\"p\",{style:{color:'#888',fontSize:'14px'},children:\"Manage AI assistant and live agent conversations\"})]}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>setShowSettings(!showSettings),style:{padding:'0.75rem 1.5rem',background:showSettings?'rgba(168, 85, 247, 0.2)':'linear-gradient(135deg, #00F0FF, #A855F7)',border:'none',borderRadius:'8px',color:showSettings?'#A855F7':'#000',fontWeight:'700',cursor:'pointer'},children:showSettings?'Hide Settings':'AI Settings'})]}),showSettings&&/*#__PURE__*/_jsxs(\"div\",{style:{background:'rgba(0, 0, 0, 0.3)',border:'1px solid rgba(0, 240, 255, 0.2)',borderRadius:'12px',padding:'1.5rem',marginBottom:'2rem'},children:[/*#__PURE__*/_jsx(\"h3\",{style:{margin:'0 0 1rem',color:'#00F0FF',fontSize:'18px',fontWeight:'700'},children:\"AI Assistant Settings\"}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1.5rem'},children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"p\",{style:{margin:0,color:'#E2E8F0',fontWeight:'600',fontSize:'14px'},children:\"AI Assistant\"}),/*#__PURE__*/_jsx(\"p\",{style:{margin:'0.25rem 0 0',color:'#888',fontSize:'13px'},children:aiSettings.ai_enabled?'AI will respond first':'All chats go directly to live agents'})]}),/*#__PURE__*/_jsx(\"button\",{onClick:toggleAiEnabled,style:{width:'60px',height:'32px',borderRadius:'16px',background:aiSettings.ai_enabled?'linear-gradient(135deg, #00F0FF, #A855F7)':'#444',border:'none',cursor:'pointer',position:'relative',transition:'all 0.3s'},children:/*#__PURE__*/_jsx(\"div\",{style:{width:'24px',height:'24px',borderRadius:'50%',background:'#fff',position:'absolute',top:'4px',left:aiSettings.ai_enabled?'32px':'4px',transition:'all 0.3s'}})})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',marginBottom:'0.5rem',color:'#888',fontSize:'13px',fontWeight:'600'},children:\"Custom AI API Key (Optional)\"}),/*#__PURE__*/_jsx(\"p\",{style:{margin:'0 0 0.75rem',color:'#666',fontSize:'12px'},children:\"Leave empty to use the default key. Add your own OpenAI key for unlimited usage.\"}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',gap:'0.75rem'},children:[/*#__PURE__*/_jsx(\"input\",{type:\"password\",value:customApiKey,onChange:e=>setCustomApiKey(e.target.value),placeholder:\"sk-...\",style:{flex:1,padding:'0.75rem',background:'rgba(0, 0, 0, 0.5)',border:'1px solid rgba(255, 255, 255, 0.1)',borderRadius:'6px',color:'#fff',fontSize:'14px'}}),/*#__PURE__*/_jsx(\"button\",{onClick:saveCustomApiKey,disabled:loading||!customApiKey.trim(),style:{padding:'0.75rem 1.5rem',background:loading||!customApiKey.trim()?'#444':'linear-gradient(135deg, #00F0FF, #A855F7)',border:'none',borderRadius:'6px',color:loading||!customApiKey.trim()?'#888':'#000',fontWeight:'700',cursor:loading||!customApiKey.trim()?'not-allowed':'pointer'},children:loading?'Saving...':'Save Key'})]}),aiSettings.has_custom_api_key&&/*#__PURE__*/_jsx(\"p\",{style:{margin:'0.5rem 0 0',color:'#22C55E',fontSize:'12px'},children:\"\\u2713 Custom API key configured\"})]})]}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',gap:'0.75rem',marginBottom:'1.5rem'},children:[/*#__PURE__*/_jsx(\"button\",{onClick:()=>setFilter('all'),style:{padding:'0.5rem 1rem',background:filter==='all'?'rgba(0, 240, 255, 0.2)':'rgba(0, 0, 0, 0.3)',border:\"1px solid \".concat(filter==='all'?'#00F0FF':'rgba(255, 255, 255, 0.1)'),borderRadius:'6px',color:filter==='all'?'#00F0FF':'#888',fontWeight:'600',fontSize:'13px',cursor:'pointer'},children:\"All Chats\"}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>setFilter('ai'),style:{padding:'0.5rem 1rem',background:filter==='ai'?'rgba(0, 240, 255, 0.2)':'rgba(0, 0, 0, 0.3)',border:\"1px solid \".concat(filter==='ai'?'#00F0FF':'rgba(255, 255, 255, 0.1)'),borderRadius:'6px',color:filter==='ai'?'#00F0FF':'#888',fontWeight:'600',fontSize:'13px',cursor:'pointer'},children:\"AI First\"}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>setFilter('live_agent'),style:{padding:'0.5rem 1rem',background:filter==='live_agent'?'rgba(168, 85, 247, 0.2)':'rgba(0, 0, 0, 0.3)',border:\"1px solid \".concat(filter==='live_agent'?'#A855F7':'rgba(255, 255, 255, 0.1)'),borderRadius:'6px',color:filter==='live_agent'?'#A855F7':'#888',fontWeight:'600',fontSize:'13px',cursor:'pointer'},children:\"Live Agent\"})]}),/*#__PURE__*/_jsxs(\"div\",{style:{display:'grid',gridTemplateColumns:'350px 1fr',gap:'1.5rem',height:'600px'},children:[/*#__PURE__*/_jsx(\"div\",{style:{background:'rgba(0, 0, 0, 0.3)',border:'1px solid rgba(0, 240, 255, 0.2)',borderRadius:'12px',overflow:'auto'},children:sessions.length===0?/*#__PURE__*/_jsx(\"div\",{style:{padding:'2rem',textAlign:'center',color:'#888'},children:/*#__PURE__*/_jsx(\"p\",{children:\"No open chat sessions\"})}):sessions.map(session=>/*#__PURE__*/_jsxs(\"div\",{onClick:()=>setSelectedSession(session),style:{padding:'1rem',borderBottom:'1px solid rgba(255, 255, 255, 0.05)',cursor:'pointer',background:(selectedSession===null||selectedSession===void 0?void 0:selectedSession.session_id)===session.session_id?'rgba(0, 240, 255, 0.1)':'transparent',transition:'background 0.2s'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',justifyContent:'space-between',alignItems:'flex-start',marginBottom:'0.5rem'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',alignItems:'center',gap:'0.5rem'},children:[session.status==='ai'?/*#__PURE__*/_jsx(Bot,{size:16,color:\"#00F0FF\"}):/*#__PURE__*/_jsx(IoPersonOutline,{size:16,color:\"#A855F7\"}),/*#__PURE__*/_jsx(\"span\",{style:{color:'#E2E8F0',fontSize:'14px',fontWeight:'600'},children:session.user_email||\"User \".concat(session.session_id.slice(0,8))})]}),/*#__PURE__*/_jsx(\"span\",{style:{color:'#666',fontSize:'11px'},children:formatTimestamp(session.last_message_at)})]}),/*#__PURE__*/_jsx(\"p\",{style:{margin:0,color:'#888',fontSize:'13px',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'},children:session.last_message||'No messages yet'}),/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:'0.5rem',display:'flex',gap:'0.5rem'},children:[session.escalated&&/*#__PURE__*/_jsx(\"span\",{style:{padding:'0.25rem 0.5rem',background:'rgba(239, 68, 68, 0.2)',color:'#EF4444',borderRadius:'4px',fontSize:'10px',fontWeight:'700'},children:\"ESCALATED\"}),/*#__PURE__*/_jsx(\"span\",{style:{padding:'0.25rem 0.5rem',background:session.status==='ai'?'rgba(0, 240, 255, 0.2)':'rgba(168, 85, 247, 0.2)',color:session.status==='ai'?'#00F0FF':'#A855F7',borderRadius:'4px',fontSize:'10px',fontWeight:'700'},children:session.status==='ai'?'AI FIRST':'LIVE AGENT'})]})]},session.session_id))}),/*#__PURE__*/_jsx(\"div\",{style:{background:'rgba(0, 0, 0, 0.3)',border:'1px solid rgba(0, 240, 255, 0.2)',borderRadius:'12px',display:'flex',flexDirection:'column'},children:selectedSession?/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsxs(\"div\",{style:{padding:'1rem 1.5rem',borderBottom:'1px solid rgba(255, 255, 255, 0.1)',display:'flex',justifyContent:'space-between',alignItems:'center'},children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"h3\",{style:{margin:0,color:'#00F0FF',fontSize:'16px',fontWeight:'700'},children:selectedSession.user_email||\"Session \".concat(selectedSession.session_id.slice(0,8))}),/*#__PURE__*/_jsx(\"p\",{style:{margin:'0.25rem 0 0',color:'#888',fontSize:'12px'},children:selectedSession.status==='ai'?'AI-first mode':'Live agent mode'})]}),/*#__PURE__*/_jsxs(\"button\",{onClick:()=>resolveChat(selectedSession.session_id),style:{padding:'0.5rem 1rem',background:'rgba(34, 197, 94, 0.2)',border:'1px solid rgba(34, 197, 94, 0.4)',borderRadius:'6px',color:'#22C55E',fontSize:'13px',fontWeight:'600',cursor:'pointer',display:'flex',alignItems:'center',gap:'0.5rem'},children:[/*#__PURE__*/_jsx(IoCheckmarkCircle,{size:16}),\"Mark Resolved\"]})]}),/*#__PURE__*/_jsx(\"div\",{style:{flex:1,overflowY:'auto',padding:'1rem',display:'flex',flexDirection:'column',gap:'1rem'},children:messages.map((msg,index)=>/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',flexDirection:msg.sender==='user'?'row-reverse':'row',gap:'0.75rem',alignItems:'flex-start'},children:[/*#__PURE__*/_jsx(\"div\",{style:{width:'32px',height:'32px',borderRadius:'50%',background:msg.sender==='user'?'linear-gradient(135deg, #A855F7, #00F0FF)':msg.sender==='ai'?'rgba(0, 240, 255, 0.2)':msg.sender==='agent'?'rgba(34, 197, 94, 0.2)':'rgba(251, 146, 60, 0.2)',display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0},children:msg.sender==='user'?/*#__PURE__*/_jsx(IoPersonOutline,{size:18,color:\"#fff\"}):msg.sender==='ai'?/*#__PURE__*/_jsx(Bot,{size:18,color:\"#00F0FF\"}):msg.sender==='agent'?/*#__PURE__*/_jsx(IoCheckmarkCircle,{size:18,color:\"#22C55E\"}):/*#__PURE__*/_jsx(IoAlertCircle,{size:18,color:\"#FB923C\"})}),/*#__PURE__*/_jsxs(\"div\",{style:{maxWidth:'70%',padding:'0.75rem 1rem',borderRadius:'12px',background:msg.sender==='user'?'linear-gradient(135deg, #A855F7, #00F0FF)':'rgba(0, 0, 0, 0.5)',color:msg.sender==='user'?'#000':'#E2E8F0',fontSize:'14px',lineHeight:'1.5',wordWrap:'break-word'},children:[msg.message,/*#__PURE__*/_jsx(\"p\",{style:{margin:'0.5rem 0 0',fontSize:'11px',opacity:0.6},children:new Date(msg.timestamp).toLocaleTimeString()})]})]},index))}),/*#__PURE__*/_jsxs(\"div\",{style:{padding:'1rem 1.5rem',borderTop:'1px solid rgba(255, 255, 255, 0.1)',display:'flex',gap:'0.75rem',alignItems:'center'},children:[/*#__PURE__*/_jsx(\"input\",{type:\"text\",value:replyMessage,onChange:e=>setReplyMessage(e.target.value),onKeyPress:e=>e.key==='Enter'&&sendReply(),placeholder:\"Type your reply...\",style:{flex:1,padding:'0.75rem 1rem',background:'rgba(0, 0, 0, 0.5)',border:'1px solid rgba(255, 255, 255, 0.1)',borderRadius:'8px',color:'#fff',fontSize:'14px',outline:'none'}}),/*#__PURE__*/_jsxs(\"button\",{onClick:sendReply,disabled:!replyMessage.trim(),style:{padding:'0.75rem 1.5rem',background:!replyMessage.trim()?'#444':'linear-gradient(135deg, #00F0FF, #A855F7)',border:'none',borderRadius:'8px',color:!replyMessage.trim()?'#888':'#000',fontWeight:'700',cursor:!replyMessage.trim()?'not-allowed':'pointer',display:'flex',alignItems:'center',gap:'0.5rem'},children:[/*#__PURE__*/_jsx(IoSend,{size:16}),\"Send\"]})]})]}):/*#__PURE__*/_jsxs(\"div\",{style:{flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',color:'#888'},children:[/*#__PURE__*/_jsx(IoChatbubbles,{size:48,color:\"#444\"}),/*#__PURE__*/_jsx(\"p\",{style:{margin:'1rem 0 0',fontSize:'14px'},children:\"Select a chat to view messages\"})]})})]})]});}","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}